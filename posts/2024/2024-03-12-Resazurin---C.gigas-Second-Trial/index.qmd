---
author: Sam White
toc-title: Contents
toc-depth: 5
toc-location: left
title: Resazurin - C.gigas Second Trial
date: '2024-03-12'
draft: true
engine: knitr
categories: 
  - Crassostrea gigas
  - Pacific oyster
  - 2024
  - resazurin
---
# INTRO

[After running the initial resazuring test on 20240308](../2024-03-08-Resazurin---Preliminary-Respiration-Test-Using-C.gigas/index.qmd) (Notebook), Steven/Ariana [asked that I run another trial](https://github.com/RobertsLab/resources/issues/1842) (GitHub Issue). This second trial was designed to get some baseline respiration from a set of oysters, followed by a heat stress at 35<sup>o</sup>C.

For this initial test, I followed the [resazurin assay](https://github.com/RobertsLab/project-gigas-carryover/blob/27441a713dfe68578758103bb82dd4dca4b4c091/protocols/Resazurin-assay.md) (commit 27441a7) shared by Steven, with the following modifications:

- Non-sterile water/sea water was used.

- No penn/strep/Fungizone used.

## Procedure

### Pre-stress

A total of nine small oysters were weighed, measured (using analog calipers). Two larger oyters were also weighed/measured and placed in their own glass Petri dishes. Fresh resazuring assay media was prepared. Two milliliters was added to 11 wells of the 12-well plate - the final position (`C04`) was left empty. Twenty milliliters was added to each Petri dish. These volumes ensured that the oysters would be submerged when added.

Fluorescence was measured on a Victor<sup>3</sup> plate reader immediatley after adding resazurin assay media to the plate and dishes. The oysters were then distributed/added to the 12-well plate and dishes. Fluorescence was measured again after 0.5 and 1.0hrs. To measure the dishes, 2mL of assay media was transferred to wells `A01` and `A02` of a clean 12-well plate (the smaller of the two oysters in `A01`).

### Heat stress @ 35<sup>o</sup>C.

As before, a fresh batch of resazurin assay media was made and distributed in a 12-well plate and two glass Petri dishes. The plate and the dishes were warmed at 35<sup>o</sup>C in a warm air incubator (Barnstead) for 45mins. The 12-well plate was covered; the Petri dishes were not. Fluorescence was measured on a Victor<sup>3</sup> plate reader immediately before  transferring oysters to the plate and dishes.

Oysters were transferred from the pre-stress plate/dishes to the pre-warmed plate/dishes. Fluorescence was measured again after 0.5 and 1.0hrs. To measure the dishes, 2mL of assay media was transferred to wells `A01` and `A02` of a clean 12-well plate (the smaller of the two oysters in `A01`).

### Plate layout

![Oysters in 12-well plate, a ruler, and oysters in two glass Petri dishes.](20240312-cgig-12_well-dishes-with_ruler.jpg){fig-alt="Oysters in 12-well plate, a ruler, and oysters in two glass Petri dishes."}

# RESULTS

## Output files

All files have been deposited in the [`project-gigas-carryover` repo](https://github.com/RobertsLab/project-gigas-carryover/tree/main/lifestage_carryover/data/resazurin_trial_02). Please visit that link to obtain files, as well as view the [`REAMDE.md` file](https://github.com/RobertsLab/project-gigas-carryover/tree/main/lifestage_carryover/data/resazurin_trial_02/REAMDE.md) for descriptions of each file.

All measurements were compiled in the following file:

- [`20240312-cgig-resazurin-trial-02.csv`](https://github.com/RobertsLab/project-gigas-carryover/blob/04a64e3bd45487b5cd631f5817937d3cd4318e70/lifestage_carryover/data/resazurin_trial_02/20240312-cgig-resazurin-trial-02.csv) (CSV; commit `04a64e3`)

## Analysis

::: callout-note
Data frame links to commit `04a64e3`.
:::

```{r setup, include=FALSE}
library(knitr)
library(dplyr)
knitr::opts_chunk$set(
  echo = TRUE,         # Display code chunks
  eval = FALSE,        # Evaluate code chunks
  warning = FALSE,     # Hide warnings
  message = FALSE,     # Hide messages
  comment = "",        # Prevents appending '##' to beginning of lines in code output
  width = 1000         # adds scroll bar
)
```


### Read in `20240312-cgig-resazurin-trial-02.csv`
```{r read-in-csv, eval=TRUE}
resazurin.df <- read.csv("https://raw.githubusercontent.com/RobertsLab/project-gigas-carryover/04a64e3bd45487b5cd631f5817937d3cd4318e70/lifestage_carryover/data/resazurin_trial_02/20240312-cgig-resazurin-trial-02.csv",
header = TRUE,
sep = ",")

str(resazurin.df)
```

### Plot pre-stress raw flourescence

```{r plot-pre-stress-raw-fluorescence, eval=TRUE}
# Load the ggplot2 library
library(ggplot2)

# Reshape the data frame from wide to long format using tidyr
library(tidyr)

resazurin.df_long <- pivot_longer(resazurin.df, 
                                  cols = starts_with("A590.prestress"), 
                                  names_to = "time_point", 
                                  values_to = "A590_prestress_value")

# Create a new column to specify the color
resazurin.df_long$color <- ifelse(grepl("^neg-control", resazurin.df_long$sample), "neg-control", resazurin.df_long$sample)

# Get unique non-"neg-control" samples
non_neg_control_samples <- setdiff(unique(resazurin.df_long$sample), "neg-control")

# Define color palette
sample_colors <- c("neg-control" = "black", 
                   setNames(rainbow(length(non_neg_control_samples)), 
                            non_neg_control_samples))

# Plot the dot plot with lines
ggplot(resazurin.df_long, aes(x = time_point, y = A590_prestress_value, group = sample, color = color)) +
  geom_point(size = 3) +  # Larger dot size
  geom_line() +  # Connect dots with lines
  scale_color_manual(values = sample_colors) +  # Assigning colors to samples
  labs(x = "Time Point", y = "Raw A590 (RFUs)", title = "Raw A590 Pre-stress Values", color = "Sample") +
  theme_minimal()
```

### Plot pre-stress control-subtracted fluorescence

```{r control-adjusted-fluorescence, eval=TRUE}
# Load required libraries
library(dplyr)
library(ggplot2)
library(tidyr)

# Step 1: Calculate the mean value of neg control samples
# Step 1: Calculate the mean value of neg control samples
neg_control_mean <- resazurin.df %>%
  filter(sample %in% c("neg-control-01", "neg-control-02")) %>%
  select(starts_with("A590.prestress")) %>%
  summarise_all(mean)

# Step 2: Subtract the mean value from other samples
resazurin_subtracted.df <- resazurin.df %>%
  mutate_at(vars(starts_with("A590.prestress")), ~ . - neg_control_mean[[1]])

# Pivot the data frame to longer format and filter out 'empty' sample
resazurin_long <- resazurin_subtracted.df %>%
  filter(!startsWith(sample, "neg-control") & sample != "empty") %>%
  pivot_longer(cols = starts_with("A590.prestress"), names_to = "Time_Point", values_to = "Mean_Subtracted_Value")

# Create dot plot with lines connecting values for each sample
ggplot(resazurin_long, aes(x = Time_Point, y = Mean_Subtracted_Value, group = sample, color = sample)) +
  geom_point() +
  geom_line() +
  labs(x = "Time Point", y = "Control-adjusted A590 (RFUs)") +
  theme(legend.position = "right")
```

### Plot pre-stress change in fluorescence per weight
```{r pre-stress-weight-adjusted}
library(tidyr)
library(dplyr)

# Step 1: Calculate the difference between A590.prestress.t.1.0 and A590.prestress.t.0
resazurin_df <- resazurin.df %>%
  mutate(diff = A590.prestress.t.1.0 - A590.prestress.t.0)

# Step 2: Calculate the mean of the difference for the neg-control samples
neg_control_mean_diff <- resazurin_df %>%
  filter(grepl("^neg-control", sample)) %>%
  summarise(mean_diff = mean(diff))

# Step 3: Subtract the mean difference from the differences of all other samples
resazurin_subtracted_df <- resazurin_df %>%
  mutate(diff_adj = diff - neg_control_mean_diff$mean_diff)

# Step 4: Divide the result by the corresponding weight.mg for each sample
resazurin_divided_df <- resazurin_subtracted_df %>%
  filter(!startsWith(sample, "neg-control") & sample != "empty") %>%
  mutate(change_per_mg = diff_adj / weight.mg)

# Reorder the levels of sample factor by weight.mg
resazurin_divided_df$sample <- factor(resazurin_divided_df$sample, levels = resazurin_divided_df$sample[order(resazurin_divided_df$weight.mg)])


ggplot(resazurin_divided_df, aes(x = sample, y = change_per_mg)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  geom_text(aes(label = weight.mg), vjust = -0.5, size = 3, color = "black") +  # Add text labels for weight.mg
  labs(x = "Sample", y = "Change in Fluorescence per mg", title = "Change in Fluorescence per mg for Each Sample") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +  # Rotate x-axis labels for better readability
  scale_x_discrete(drop = FALSE) +  # Retain all levels of sample factor
  annotate("text", x = -0.1, y = -2.5, label = "Small", size = 6, color = "black", hjust = 0) +  # Annotation for small
  annotate("text", x = nrow(resazurin_divided_df) + 0.5, y = -2.5, label = "Large", size = 6, color = "black", hjust = 1) +  # Annotation for large
  geom_segment(aes(x = -0.1, xend = nrow(resazurin_divided_df) + 0.5, y = -0.6, yend = -0.6), arrow = arrow(type = "open", length = unit(0.2, "inches")), size = 2.0)  # Arrow indicating scale

```