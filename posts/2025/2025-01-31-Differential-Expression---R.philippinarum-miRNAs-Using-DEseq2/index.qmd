---
author: Sam White
toc-title: Contents
toc-depth: 5
toc-location: left
title: Differential Expression - R.philippinarum miRNAs Using DEseq2
date: '2025-01-31'
draft: false
engine: knitr
categories: 
  - "2025"
  - "Ruditapes philippinarum"
  - "Manila clam"
  - "DEseq2"
  - "sRNA-seq"
  - "miRNA"
---
This analysis was done as part of [`project-clam-oa`](https://github.com/RobertsLab/project-clam-oa) (GitHub repo).

::: {.callout-note}
The contents below are from markdown knitted from [`03.00-D-sRNAseq-gene-expression-DESeq2.Rmd`](https://github.com/RobertsLab/project-clam-oa/blob/af1eb6d98e99a6e3c51d37084f7df143d02c322d/code/03.00-D-sRNAseq-gene-expression-DESeq2.Rmd) (commit `af1eb6d`).
:::

# 1 Background

This will run
[DEseq2](https://bioconductor.org/packages/release/bioc/vignettes/DESeq2/inst/doc/DESeq2.html)
(Love, Huber, and Anders 2014) to determine if any of the miRNAs
identified in
[02.00-ShortStack-31bp-fastp-merged.md](https://github.com/RobertsLab/project-clam-oa/blob/2616d45a5a0bbef23081c5824bfe5bad6b89d227/code/02.00-ShortStack-31bp-fastp-merged.md)
analysis are differentially expressed between control/treatment.

This was initially run with a log2 fold change threshold set to 1 (which
is equivalent to a 2-fold change in expression), but that returned 0
differentially expressed miRNAs. As such, this was run again with the
log2 fold change threshold set to 0.

<div class="callout-note">

ShortStack identified 37 miRNAs.

</div>

## 1.1 Inputs

- [`Counts.txt`](https://github.com/RobertsLab/project-clam-oa/blob/d380ed9a88c874db5434c9ec74f6ab1de042bad5/output/02.00-ShortStack-31bp-fastp-merged/ShortStack_out/Counts.txt):
  ShortStack counts matrix. Includes all clusters, including those that
  were *not* categorized as miRNAs.

- [`DESeq2-coldata.tab`](https://github.com/RobertsLab/project-clam-oa/blob/d380ed9a88c874db5434c9ec74f6ab1de042bad5/output/03.00-D-sRNAseq-gene-expression-DESeq2/DESeq2-coldata.tab):
  Two column table with sample ID and treatment. This file is also an
  output from this notebook.

- [ManilaOA2023_shortRNASeq_Meta.csv](https://github.com/RobertsLab/project-clam-oa/blob/d380ed9a88c874db5434c9ec74f6ab1de042bad5/data/ManilaOA2023_shortRNASeq_Meta.csv):
  Metadata file for this sRNA-seq data.

## 1.2 Outputs

- [`DESeq2-coldata.tab`](https://github.com/RobertsLab/project-clam-oa/blob/d380ed9a88c874db5434c9ec74f6ab1de042bad5/output/03.00-D-sRNAseq-gene-expression-DESeq2/DESeq2-coldata.tab):
  Two column table with sample ID and treatment. Needed as input to
  DEseq2.

- [`deseq2.table.csv`](https://github.com/RobertsLab/project-clam-oa/blob/d380ed9a88c874db5434c9ec74f6ab1de042bad5/output/03.00-D-sRNAseq-gene-expression-DESeq2/deseq2.table.csv):
  DEseq2 output table containing mean expression, fold change in
  expression, and adjusted p-values for all input samples.

- [deseq2.fdr-0.05.lfc-0.table.csv](https://github.com/RobertsLab/project-clam-oa/blob/3b23f7cfcdf9cef627556090518d60d685d881bd/output/03.00-D-sRNAseq-gene-expression-DESeq2/deseq2.fdr-0.05.lfc-0.table.csv):
  Subset of DEseq2 output table of all miRNA clusters (“genes”) having
  adjusted p-values (fdr) \<= 0.05 with log2 fold change cutoff set to

  0.  

# 2 Set R variables

``` r
# Define the output directory path
output_dir <- "../output/03.00-D-sRNAseq-gene-expression-DESeq2/"

# Set desired false discovery rate threshold (i.e. adjusted p-value, padj)
fdr <- 0.05

# Set log2 fold change threshold (a value of '1' is equal to a fold change of '2')
log2fc <- 0
```

# 3 Load count data

Load in the sRNA count matrix generated using ShortStack 4.1.1. Keep in
mind this data includes counts of all sRNAs, not just miRNAs.

Counts generated in `02.00-ShortStack-31bp-fastp-merged`.

## 3.1 Select only miRNAs IDd by ShortStack

``` r
# Read in sRNA counts data
srna_seq_counts_shortstack <- read_delim("../output/02.00-ShortStack-31bp-fastp-merged/ShortStack_out/Counts.txt", delim="\t")

srna_seq_counts_shortstack <- srna_seq_counts_shortstack %>% filter(MIRNA == "Y")

str(srna_seq_counts_shortstack)
```

    spc_tbl_ [37 × 23] (S3: spec_tbl_df/tbl_df/tbl/data.frame)
     $ Coords                                        : chr [1:37] "NW_026852415.1:231396-231495" "NW_026852524.1:285406-285505" "NW_026852815.1:56435-56532" "NW_026853363.1:213466-213568" ...
     $ Name                                          : chr [1:37] "Cluster_1785" "Cluster_2042" "Cluster_2646" "Cluster_3720" ...
     $ MIRNA                                         : chr [1:37] "Y" "Y" "Y" "Y" ...
     $ 196-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 693 108457 1808 37 9 ...
     $ 199-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 503 137906 1592 24 4 ...
     $ 211-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 663 154248 2026 23 2 ...
     $ 24-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 557 136805 1276 34 8 ...
     $ 260-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 1419 120261 1468 178 8 ...
     $ 26-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 559 124995 1580 29 0 ...
     $ 30-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 780 157279 2265 19 4 ...
     $ 310-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 569 154690 1765 15 2 ...
     $ 33-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 442 116913 1420 13 9 ...
     $ 341-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 728 121161 1344 7 2 ...
     $ 34-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 665 143730 1736 14 5 ...
     $ 35-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 607 128534 1683 26 1 ...
     $ 363-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 538 95266 1408 15 6 ...
     $ 367-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 520 119389 1315 7 1 ...
     $ 376-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 1029 217736 2833 14 2 ...
     $ 460-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 571 139439 1466 9 6 ...
     $ 485-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 579 154776 1747 11 4 ...
     $ 501-fastp-adapters-polyG-31bp-merged_condensed: num [1:37] 1182 167181 2135 174 3 ...
     $ 71-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 392 1097 11123 1248 5 ...
     $ 88-fastp-adapters-polyG-31bp-merged_condensed : num [1:37] 552 136133 1808 9 1 ...
     - attr(*, "spec")=
      .. cols(
      ..   Coords = col_character(),
      ..   Name = col_character(),
      ..   MIRNA = col_character(),
      ..   `196-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `199-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `211-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `24-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `260-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `26-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `30-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `310-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `33-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `341-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `34-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `35-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `363-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `367-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `376-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `460-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `485-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `501-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `71-fastp-adapters-polyG-31bp-merged_condensed` = col_double(),
      ..   `88-fastp-adapters-polyG-31bp-merged_condensed` = col_double()
      .. )
     - attr(*, "problems")=<externalptr> 

# 4 Create DESeq2 Column Data

## 4.1 Read in metadata CSV

``` r
# Load metadata
metadata <- read.csv("../data/ManilaOA2023_shortRNASeq_Meta.csv", header = TRUE)

str(metadata)
```

    'data.frame':   20 obs. of  6 variables:
     $ ID_simple  : int  196 199 211 310 341 363 367 376 460 485 ...
     $ treatment  : chr  "control" "control" "control" "control" ...
     $ Sex        : logi  FALSE FALSE FALSE FALSE FALSE FALSE ...
     $ MeanEggArea: int  NA 3687 3519 3795 3837 3749 NA 3834 3759 NA ...
     $ Species    : chr  "Manila clam" "Manila clam" "Manila clam" "Manila clam" ...
     $ LifeStage  : chr  "Adult" "Adult" "Adult" "Adult" ...

## 4.2 Extract sample names

``` r
sample_names <- colnames(srna_seq_counts_shortstack) %>%
  str_subset("^\\d+-") %>%
  str_extract("^\\d+")

str(sample_names)
```

     chr [1:20] "196" "199" "211" "24" "260" "26" "30" "310" "33" "341" "34" ...

## 4.3 Select sample name and treatment

``` r
sample_treatment_df <- metadata %>%
  select(ID_simple, treatment)

# Set sample names as rownames
rownames(sample_treatment_df) <- sample_treatment_df$ID_simple

sample_treatment_df$ID_simple <- NULL

str(sample_treatment_df)
```

    'data.frame':   20 obs. of  1 variable:
     $ treatment: chr  "control" "control" "control" "control" ...

## 4.4 Write DEseq coldata to file

``` r
write.table(
  sample_treatment_df,
  file = "../output/03.00-D-sRNAseq-gene-expression-DESeq2/DESeq2-coldata.tab",
  sep = "\t",
  quote = FALSE,
  col.names = NA
)
```

# 5 Count data munging

## 5.1 Fix col names and convert to matrix

``` r
coldata <- sample_treatment_df

# Remove excess portions of sample column names to just "sample###"
colnames(srna_seq_counts_shortstack) <- sub("-fastp-adapters-polyG-31bp-merged_condensed", "", colnames(srna_seq_counts_shortstack))

# Keep just the counts and cluster names as matrix
srna_seq_counts_matrix <- as.matrix(srna_seq_counts_shortstack %>% select(-Coords, -MIRNA) %>% column_to_rownames(var = "Name"))

str(srna_seq_counts_matrix)
```

     num [1:37, 1:20] 693 108457 1808 37 9 ...
     - attr(*, "dimnames")=List of 2
      ..$ : chr [1:37] "Cluster_1785" "Cluster_2042" "Cluster_2646" "Cluster_3720" ...
      ..$ : chr [1:20] "196" "199" "211" "24" ...

## 5.2 Take only samples present in coldata

``` r
common_cols <- intersect(colnames(srna_seq_counts_matrix),
                         rownames(sample_treatment_df))

srna_seq_counts_matrix <- srna_seq_counts_matrix[, common_cols]

str(srna_seq_counts_matrix)
```

     num [1:37, 1:20] 693 108457 1808 37 9 ...
     - attr(*, "dimnames")=List of 2
      ..$ : chr [1:37] "Cluster_1785" "Cluster_2042" "Cluster_2646" "Cluster_3720" ...
      ..$ : chr [1:20] "196" "199" "211" "24" ...

## 5.3 Reorder matrix cols to match coldata

``` r
ord <- match(rownames(sample_treatment_df), colnames(srna_seq_counts_matrix))

srna_seq_counts_matrix_sorted <- srna_seq_counts_matrix[, ord]

str(srna_seq_counts_matrix_sorted)
```

     num [1:37, 1:20] 693 108457 1808 37 9 ...
     - attr(*, "dimnames")=List of 2
      ..$ : chr [1:37] "Cluster_1785" "Cluster_2042" "Cluster_2646" "Cluster_3720" ...
      ..$ : chr [1:20] "196" "199" "211" "310" ...

## 5.4 Verify rownames match

``` r
all(rownames(coldata) == colnames(srna_seq_counts_matrix_sorted))
```

    [1] TRUE

# 6 Create DESeq2 data set

## 6.1 Initialize DEseq2 data set

``` r
dds <- DESeqDataSetFromMatrix(countData = srna_seq_counts_matrix_sorted,
                              colData = coldata,
                              design = ~ treatment)
dds
```

    class: DESeqDataSet 
    dim: 37 20 
    metadata(1): version
    assays(1): counts
    rownames(37): Cluster_1785 Cluster_2042 ... Cluster_32918 Cluster_32919
    rowData names(0):
    colnames(20): 196 199 ... 71 260
    colData names(1): treatment

## 6.2 Add cluster column as “gene” feature

``` r
featureData <- data.frame(gene=rownames(srna_seq_counts_matrix_sorted))
mcols(dds) <- DataFrame(mcols(dds), featureData)
mcols(dds)
```

    DataFrame with 37 rows and 1 column
                           gene
                    <character>
    Cluster_1785   Cluster_1785
    Cluster_2042   Cluster_2042
    Cluster_2646   Cluster_2646
    Cluster_3720   Cluster_3720
    Cluster_4396   Cluster_4396
    ...                     ...
    Cluster_29018 Cluster_29018
    Cluster_31844 Cluster_31844
    Cluster_32917 Cluster_32917
    Cluster_32918 Cluster_32918
    Cluster_32919 Cluster_32919

## 6.3 Set factor levels

``` r
dds$treatment <- factor(dds$treatment, levels = c("control", "treatment"))
```

# 7 DESeq analysis

## 7.1 DEseq

``` r
dds <- DESeq(dds)
```

## 7.2 DEseq Results

``` r
res <- results(dds, alpha = fdr, lfcThreshold = log2fc)

res
```

    log2 fold change (MLE): treatment treatment vs control 
    Wald test p-value: treatment treatment vs control 
    DataFrame with 37 rows and 6 columns
                     baseMean log2FoldChange     lfcSE       stat      pvalue
                    <numeric>      <numeric> <numeric>  <numeric>   <numeric>
    Cluster_1785  6.63895e+02      0.0149611 0.2810643  0.0532301 0.957548604
    Cluster_2042  1.35312e+05     -0.1901409 0.4840889 -0.3927810 0.694481249
    Cluster_2646  1.76900e+03      0.0185890 0.0902545  0.2059620 0.836820596
    Cluster_3720  4.26842e+01      2.0921221 0.5504186  3.8009659 0.000144133
    Cluster_4396  4.09498e+00      0.0360325 0.5609930  0.0642299 0.948787181
    ...                   ...            ...       ...        ...         ...
    Cluster_29018   1661.6392      2.4245029  0.683762   3.545830 0.000391378
    Cluster_31844   1372.1080     -0.0477386  0.146375  -0.326140 0.744318793
    Cluster_32917     14.7573      0.2194667  0.377211   0.581814 0.560691835
    Cluster_32918   1259.4586      0.5004769  0.370048   1.352466 0.176226232
    Cluster_32919      4.5894      0.2954022  0.619287   0.477004 0.633359369
                        padj
                   <numeric>
    Cluster_1785  0.98414718
    Cluster_2042  0.94314745
    Cluster_2646  0.96982079
    Cluster_3720  0.00482699
    Cluster_4396  0.98414718
    ...                  ...
    Cluster_29018 0.00482699
    Cluster_31844 0.94964812
    Cluster_32917 0.94314745
    Cluster_32918 0.57114000
    Cluster_32919 0.94314745

``` r
summary(res)
```

    out of 37 with nonzero total read count
    adjusted p-value < 0.05
    LFC > 0 (up)       : 3, 8.1%
    LFC < 0 (down)     : 1, 2.7%
    outliers [1]       : 0, 0%
    low counts [2]     : 0, 0%
    (mean count < 4)
    [1] see 'cooksCutoff' argument of ?results
    [2] see 'independentFiltering' argument of ?results

``` r
table(res$padj < fdr)
```

    FALSE  TRUE 
       33     4 

## 7.3 Write DDS results tables to CSVs

``` r
write.csv(res, file = paste0(output_dir, "deseq2", ".table.csv"), row.names = TRUE, quote = FALSE)

# Subset based on adjusted p-value
resSig <- subset(res, padj < fdr)

resSig
```

    log2 fold change (MLE): treatment treatment vs control 
    Wald test p-value: treatment treatment vs control 
    DataFrame with 4 rows and 6 columns
                    baseMean log2FoldChange     lfcSE      stat      pvalue
                   <numeric>      <numeric> <numeric> <numeric>   <numeric>
    Cluster_3720    42.68419        2.09212  0.550419   3.80097 0.000144133
    Cluster_15325   27.20988        4.27878  1.188934   3.59883 0.000319647
    Cluster_17619    7.68082       -2.71853  0.785237  -3.46205 0.000536073
    Cluster_29018 1661.63918        2.42450  0.683762   3.54583 0.000391378
                        padj
                   <numeric>
    Cluster_3720  0.00482699
    Cluster_15325 0.00482699
    Cluster_17619 0.00495868
    Cluster_29018 0.00482699

``` r
write.csv(resSig, file = paste0(output_dir, "deseq2",".fdr-", fdr, ".lfc-", log2fc, ".table.csv"), row.names = TRUE, quote = FALSE)
```

## 7.4 Identify Differentially Expressed miRNAs

``` bash


# Extract the first column values (excluding the header)
clusters=$(cut -d',' -f1 "../output/03.00-D-sRNAseq-gene-expression-DESeq2/deseq2.fdr-0.05.lfc-0.table.csv" | tail -n +2)

# Loop through each cluster and search in the Results.txt file
for cluster in $clusters; 
do
    grep "$cluster" "../output/02.00-ShortStack-31bp-fastp-merged/ShortStack_out/Results.txt"
done

echo ""
echo "--------------------------------------------------------------"
echo ""

for cluster in $clusters; 
do
    grep "$cluster" "../output/02.00-ShortStack-31bp-fastp-merged/ShortStack_out/Results.txt" \
    | awk '{print $21}'
done
```

    NW_026853363.1:213466-213568    Cluster_3720    NW_026853363.1  213466  213568  103 1906    84  1.0 +   AGAUAUGUUUGAUAUAUUUGGU  864 9   11  129 1048    458 251 22  Y   cte-miR-190;mle-miR-190-5p
    NW_026858897.1:43133-43248  Cluster_15325   NW_026858897.1  43133   43248   116 1294    54  0.98    +   UGUUCUACGAGCUGUAGCUGU   685 4   34  796 431 29  0   21  Y   NA
    NW_026859924.1:190953-191067    Cluster_17619   NW_026859924.1  190953  191067  115 852 54  0.012   -   UGUUCUACGAGCUGUAACUGUC  509 4   70  175 593 10  0   22  Y   NA
    NW_026865271.1:194028-194125    Cluster_29018   NW_026865271.1  194028  194125  98  66793   264 1.0 +   UCACAACCUGCUUGAAUGAGGAC 31912   323 43  462 5039    38213   22713   23  Y   mle-miR-67-3p

    --------------------------------------------------------------

    cte-miR-190;mle-miR-190-5p
    NA
    NA
    mle-miR-67-3p

# 8 Variance stabilizing transformations (VST)

- Here we transform counts using a variance stabilizing transformation
  (VST), since we have many samples.

``` r
vsd <- varianceStabilizingTransformation(dds, blind=FALSE)
```

# 9 Plotting

## 9.1 Sample distances

``` r
sampleDists <- dist(t(assay(vsd)))

sampleDistMatrix <- as.matrix( sampleDists )

rownames(sampleDistMatrix) <- paste( vsd$colony.id, vsd$time.point, sep = " - " )

colnames(sampleDistMatrix) <- NULL

colors <- colorRampPalette( rev(brewer.pal(9, "Blues")) )(255)

pheatmap(sampleDistMatrix,
         clustering_distance_rows = sampleDists,
         clustering_distance_cols = sampleDists,
         col = colors)
```

## 9.2 PCA

Visualize sample clustering via PCA (after transformation)

``` r
# PCA with points color coded by time point 
plotPCA(vsd, intgroup = c("treatment"))
```

![](03.00-D-sRNAseq-gene-expression-DESeq2_files/figure-gfm/pca-1.png)<!-- -->

## 9.3 Heatmap of all 37 ShortStack miRNAs

``` r
top40_counts <- order(rowMeans(counts(dds,normalized=TRUE)),
                decreasing=TRUE)[1:37]

annotation = colData(dds) %>% as.data.frame() %>% select(treatment)

pheatmap(assay(vsd)[top40_counts,], 
         cluster_rows=FALSE, 
         show_rownames=TRUE,
         cluster_cols=TRUE, 
         annotation_col = annotation)
```

![](03.00-D-sRNAseq-gene-expression-DESeq2_files/figure-gfm/heatmap-1.png)<!-- -->

# 10 REFERENCES

<div id="refs" class="references csl-bib-body hanging-indent">

<div id="ref-love2014" class="csl-entry">

Love, Michael I, Wolfgang Huber, and Simon Anders. 2014. “Moderated
Estimation of Fold Change and Dispersion for RNA-Seq Data with DESeq2.”
*Genome Biology* 15 (12). <https://doi.org/10.1186/s13059-014-0550-8>.

</div>

</div>