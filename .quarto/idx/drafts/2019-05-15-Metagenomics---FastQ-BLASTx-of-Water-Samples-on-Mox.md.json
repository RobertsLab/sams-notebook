{"title":"Metagenomics - FastQ BLASTx of Water Samples on Mox","markdown":{"yaml":{"layout":"post","title":"Metagenomics - FastQ BLASTx of Water Samples on Mox","date":"2019-05-15 15:07","tags":["metagenomics","Panopea generosa","geoduck","mox","blastx","seqkt"],"categories":["Miscellaneous"]},"headingText":"RESULTS","containsRefs":false,"markdown":"\nAfter a meeting on this project today, we decided to try a few things to continue with various approaches to assessing the metagenome. One of the approaches is to just run BLASTx on the FastQ sequences themselves and obtain taxonomy info for them, so that's what I did here.\n\nUsed the trimmed reads from [20181211](https://robertslab.github.io/sams-notebook/2018/12/11/FastQC-and-Trimming-Metagenomics-(Geoduck)-HiSeqX-Reads-from-20180809.html) as input and combined corresponding paired-end reads into a singular FastA file using [seqkt v1.3](https://github.com/lh3/seqtk/releases/tag/v1.3).\n\nSamples breakdown like so:\n\n- pH=7.1: MG3, MG6, MG7\n\n- pH=8.2: MG1, MG2, MG5\n\nSBATCH script (GitHub):\n\n- [20190515_metagenomics_pgen_fastq_blastx.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20190515_metagenomics_pgen_fastq_blastx.sh)\n\n```shell\n    #!/bin/bash\n    ## Job Name\n    #SBATCH --job-name=blastx_metagenomics\n    ## Allocation Definition\n    #SBATCH --account=coenv\n    #SBATCH --partition=coenv\n    ## Resources\n    ## Nodes\n    #SBATCH --nodes=1\n    ## Walltime (days-hours:minutes:seconds format)\n    #SBATCH --time=25-00:00:00\n    ## Memory per node\n    #SBATCH --mem=120G\n    ##turn on e-mail notification\n    #SBATCH --mail-type=ALL\n    #SBATCH --mail-user=samwhite@uw.edu\n    ## Specify the working directory for this job\n    #SBATCH --workdir=/gscratch/scrubbed/samwhite/outputs/20190515_metagenomics_pgen_fastq_blastx    \n\n    # Exit script if any command fails\n    set -e    \n\n    # Load Python Mox module for Python module availability    \n\n    module load intel-python3_2017    \n\n    # Document programs in PATH (primarily for program version ID)    \n\n    date >> system_path.log\n    echo \"\" >> system_path.log\n    echo \"System PATH for $SLURM_JOB_ID\" >> system_path.log\n    echo \"\" >> system_path.log\n    printf \"%0.s-\" {1..10} >> system_path.log\n    echo \"${PATH}\" | tr : \\\\n >> system_path.log    \n\n\n    threads=28    \n\n    # Paths to programs\n    blast_dir=\"/gscratch/srlab/programs/ncbi-blast-2.8.1+/bin\"\n    blastx=\"${blast_dir}/blastx\"\n    seqtk=\"/gscratch/srlab/programs/seqtk-1.3/seqtk\"    \n\n    # Paths to blastdbs\n    blastdb_dir=\"/gscratch/srlab/blastdbs/ncbi-sp-v5\"\n    blast_db=\"${blastdb_dir}/swissprot_v5\"\n    samtools=\"/gscratch/srlab/programs/samtools-1.9/samtools\"    \n\n    # Input files\n    fastq_dir=\"/gscratch/srlab/sam/data/metagenomics/P_generosa/\"    \n\n\n    ## Inititalize arrays\n    fastq_array_R1=()\n    fastq_array_R2=()\n    names_array=()    \n\n    # Create array of fastq R1 files\n    for fastq in ${fastq_dir}/*R1*.gz\n    do\n      fastq_array_R1+=(${fastq})\n    done    \n\n    # Create array of fastq R2 files\n    for fastq in ${fastq_dir}/*R2*.gz\n    do\n      fastq_array_R2+=(${fastq})\n    done    \n\n    # Create array of sample names\n    ## Uses parameter substitution to strip leading path from filename\n    ## Uses awk to parse out sample name from filename\n    for R1_fastq in ${fastq_dir}/*R1*.gz\n    do\n      names_array+=($(echo ${R1_fastq#${fastq_dir}} | awk -F\"_\" '{print $3 $4}'))\n    done    \n\n    # Create list of fastq files used in analysis\n    ## Uses parameter substitution to strip leading path from filename\n    for fastq in ${fastq_dir}*.gz\n    do\n      echo \"${fastq#${fastq_dir}}\" >> fastq.list.txt\n    done    \n\n    # Merge paired-end reads into singular FastA files\n    # Uses seqtk for FastQ/FastA manipulation.\n    for index in \"${!fastq_array_R1[@]}\"\n    do\n      sample_name=$(echo \"${names_array[index]}\")\n      if [ \"${sample_name}\" == \"MG1\" ] \\\n      || [ \"${sample_name}\" == \"MG2\" ] \\\n      || [ \"${sample_name}\" == \"MG5\" ]\n      then\n        sample_name=\"${sample_name}\"_pH82\n      else\n        sample_name=\"${sample_name}\"_pH71\n      fi\n      \"${seqtk}\" mergefa \"${fastq_array_R1[index]}\" \"${fastq_array_R2[index]}\" > \"${sample_name}\".fasta\n    done    \n\n    # Export BLAST database directory\n    export BLASTDB=${blastdb_dir}    \n\n    # Loop through FastAs\n    # Create list of those FastAs for reference\n    # Parse out sample names\n    # Run BLASTx on each FastA\n    for fasta in *.fasta\n    do\n      echo \"${fasta}\" >> input.fasta.list.txt\n      \"${samtools}\" faidx \"${fasta}\"\n      no_ext=${fasta%%.*}\n      sample_name=$(echo ${no_ext##*/})    \n\n      # Run BLASTx on each FastA\n      ${blastx} \\\n      -query \"${fasta}\" \\\n      -db ${blast_db} \\\n      -max_hsps 1 \\\n      -outfmt \"6 std staxid ssciname\" \\\n      -evalue 1e-10 \\\n      -num_threads ${threads} \\\n      > \"${sample_name}\".blastx.outfmt6\n    done\n```\n\n\nOof, after running for over _nine days_ the Mox node crashed this past weekend:\n\n![Screencap of blastx node failure notification](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20190607_blastx_node_fail.png?raw=true)\n\n---\n\n\nOutput folder:\n\n- [20190515_metagenomics_pgen_fastq_blastx](http://gannet.fish.washington.edu/Atumefaciens/20190515_metagenomics_pgen_fastq_blastx)\n","srcMarkdownNoYaml":"\nAfter a meeting on this project today, we decided to try a few things to continue with various approaches to assessing the metagenome. One of the approaches is to just run BLASTx on the FastQ sequences themselves and obtain taxonomy info for them, so that's what I did here.\n\nUsed the trimmed reads from [20181211](https://robertslab.github.io/sams-notebook/2018/12/11/FastQC-and-Trimming-Metagenomics-(Geoduck)-HiSeqX-Reads-from-20180809.html) as input and combined corresponding paired-end reads into a singular FastA file using [seqkt v1.3](https://github.com/lh3/seqtk/releases/tag/v1.3).\n\nSamples breakdown like so:\n\n- pH=7.1: MG3, MG6, MG7\n\n- pH=8.2: MG1, MG2, MG5\n\nSBATCH script (GitHub):\n\n- [20190515_metagenomics_pgen_fastq_blastx.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20190515_metagenomics_pgen_fastq_blastx.sh)\n\n```shell\n    #!/bin/bash\n    ## Job Name\n    #SBATCH --job-name=blastx_metagenomics\n    ## Allocation Definition\n    #SBATCH --account=coenv\n    #SBATCH --partition=coenv\n    ## Resources\n    ## Nodes\n    #SBATCH --nodes=1\n    ## Walltime (days-hours:minutes:seconds format)\n    #SBATCH --time=25-00:00:00\n    ## Memory per node\n    #SBATCH --mem=120G\n    ##turn on e-mail notification\n    #SBATCH --mail-type=ALL\n    #SBATCH --mail-user=samwhite@uw.edu\n    ## Specify the working directory for this job\n    #SBATCH --workdir=/gscratch/scrubbed/samwhite/outputs/20190515_metagenomics_pgen_fastq_blastx    \n\n    # Exit script if any command fails\n    set -e    \n\n    # Load Python Mox module for Python module availability    \n\n    module load intel-python3_2017    \n\n    # Document programs in PATH (primarily for program version ID)    \n\n    date >> system_path.log\n    echo \"\" >> system_path.log\n    echo \"System PATH for $SLURM_JOB_ID\" >> system_path.log\n    echo \"\" >> system_path.log\n    printf \"%0.s-\" {1..10} >> system_path.log\n    echo \"${PATH}\" | tr : \\\\n >> system_path.log    \n\n\n    threads=28    \n\n    # Paths to programs\n    blast_dir=\"/gscratch/srlab/programs/ncbi-blast-2.8.1+/bin\"\n    blastx=\"${blast_dir}/blastx\"\n    seqtk=\"/gscratch/srlab/programs/seqtk-1.3/seqtk\"    \n\n    # Paths to blastdbs\n    blastdb_dir=\"/gscratch/srlab/blastdbs/ncbi-sp-v5\"\n    blast_db=\"${blastdb_dir}/swissprot_v5\"\n    samtools=\"/gscratch/srlab/programs/samtools-1.9/samtools\"    \n\n    # Input files\n    fastq_dir=\"/gscratch/srlab/sam/data/metagenomics/P_generosa/\"    \n\n\n    ## Inititalize arrays\n    fastq_array_R1=()\n    fastq_array_R2=()\n    names_array=()    \n\n    # Create array of fastq R1 files\n    for fastq in ${fastq_dir}/*R1*.gz\n    do\n      fastq_array_R1+=(${fastq})\n    done    \n\n    # Create array of fastq R2 files\n    for fastq in ${fastq_dir}/*R2*.gz\n    do\n      fastq_array_R2+=(${fastq})\n    done    \n\n    # Create array of sample names\n    ## Uses parameter substitution to strip leading path from filename\n    ## Uses awk to parse out sample name from filename\n    for R1_fastq in ${fastq_dir}/*R1*.gz\n    do\n      names_array+=($(echo ${R1_fastq#${fastq_dir}} | awk -F\"_\" '{print $3 $4}'))\n    done    \n\n    # Create list of fastq files used in analysis\n    ## Uses parameter substitution to strip leading path from filename\n    for fastq in ${fastq_dir}*.gz\n    do\n      echo \"${fastq#${fastq_dir}}\" >> fastq.list.txt\n    done    \n\n    # Merge paired-end reads into singular FastA files\n    # Uses seqtk for FastQ/FastA manipulation.\n    for index in \"${!fastq_array_R1[@]}\"\n    do\n      sample_name=$(echo \"${names_array[index]}\")\n      if [ \"${sample_name}\" == \"MG1\" ] \\\n      || [ \"${sample_name}\" == \"MG2\" ] \\\n      || [ \"${sample_name}\" == \"MG5\" ]\n      then\n        sample_name=\"${sample_name}\"_pH82\n      else\n        sample_name=\"${sample_name}\"_pH71\n      fi\n      \"${seqtk}\" mergefa \"${fastq_array_R1[index]}\" \"${fastq_array_R2[index]}\" > \"${sample_name}\".fasta\n    done    \n\n    # Export BLAST database directory\n    export BLASTDB=${blastdb_dir}    \n\n    # Loop through FastAs\n    # Create list of those FastAs for reference\n    # Parse out sample names\n    # Run BLASTx on each FastA\n    for fasta in *.fasta\n    do\n      echo \"${fasta}\" >> input.fasta.list.txt\n      \"${samtools}\" faidx \"${fasta}\"\n      no_ext=${fasta%%.*}\n      sample_name=$(echo ${no_ext##*/})    \n\n      # Run BLASTx on each FastA\n      ${blastx} \\\n      -query \"${fasta}\" \\\n      -db ${blast_db} \\\n      -max_hsps 1 \\\n      -outfmt \"6 std staxid ssciname\" \\\n      -evalue 1e-10 \\\n      -num_threads ${threads} \\\n      > \"${sample_name}\".blastx.outfmt6\n    done\n```\n\n\nOof, after running for over _nine days_ the Mox node crashed this past weekend:\n\n![Screencap of blastx node failure notification](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20190607_blastx_node_fail.png?raw=true)\n\n---\n\n#### RESULTS\n\nOutput folder:\n\n- [20190515_metagenomics_pgen_fastq_blastx](http://gannet.fish.washington.edu/Atumefaciens/20190515_metagenomics_pgen_fastq_blastx)\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../styles.css"],"toc":true,"output-file":"2019-05-15-Metagenomics---FastQ-BLASTx-of-Water-Samples-on-Mox.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"layout":"post","title":"Metagenomics - FastQ BLASTx of Water Samples on Mox","date":"2019-05-15 15:07","tags":["metagenomics","Panopea generosa","geoduck","mox","blastx","seqkt"],"categories":["Miscellaneous"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}