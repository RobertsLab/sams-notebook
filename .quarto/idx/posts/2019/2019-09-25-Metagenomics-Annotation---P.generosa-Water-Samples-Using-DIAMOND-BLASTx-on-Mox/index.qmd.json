{"title":"Metagenomics Annotation - P.generosa Water Samples Using DIAMOND BLASTx on Mox","markdown":{"yaml":{"author":"Sam White","toc-title":"Contents","toc-depth":5,"toc-location":"left","layout":"post","title":"Metagenomics Annotation - P.generosa Water Samples Using DIAMOND BLASTx on Mox","date":"2019-09-25 14:34","tags":["Panopea generosa","geoduck","metagenomics","DIAMOND","mox","MEGAN6"],"categories":["2019","Miscellaneous"]},"headingText":"Job Name","containsRefs":false,"markdown":"\nWe recently had a meeting with Emma and Brook about the progress of this metagenomics project and Brook suggested trying out [MEGAN6](https://ab.inf.uni-tuebingen.de/software/megan6) as user-friendly way to get these samples annotated.\n\nAlthough [MEGAN6](https://ab.inf.uni-tuebingen.de/software/megan6) will accept BLAST output as input, it has to be formatted in a certain way. Although I've previously BLASTed these data, the outputs of those were not formatted in a way that is readily able to be imported into MEGAN6, so instead I opted to re-BLAST these using [DIAMOND](https://github.com/bbuchfink/diamond) (which is produced by the same group that created MEGAN6), as it is significantly faster than BLASTx and has output formats that are geared towards import to MEGAN6.\n\nI downloaded the NCBI nr BLASTdb in FastA format:\n\n`ftp://ftp.ncbi.nih.gov/blast/db/FASTA/nr.gz`\n\nI prepared the DIAMOND BLASTdb (`nr.dmnd`) with the following command:\n\n```shell\n/gscratch/srlab/programs/diamond-0.9.26/diamond makedb \\\n--in nr.faa \\\n-d nr \\\n--taxonmap prot.accession2taxid \\\n--taxonnodes nodes.dmp\n```\nThe taxonmap and taxon node files were downloaded from the following NCBI locations:\n\n- `ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/accession2taxid/prot.accession2taxid.gz`\n\n- `ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdmp.zip`\n\n\nSBATCH script (GitHub):\n\n- [20190923_pgen_fastp_EPI_trimming.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20190923_pgen_fastp_EPI_trimming.sh)\n\n```shell\n#!/bin/bash\n#SBATCH --job-name=metagenomics_DIAMOND\n## Allocation Definition\n#SBATCH --account=coenv\n#SBATCH --partition=coenv\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=6-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20190925_metagenomics_DIAMOND_blastx\n\n## Perform DIAMOND BLASTx on trimmed geoduck water metagnomics FastQ files,\n## and prepare them for analysis in MEGAN6 by running daa-meganizer on them.\n## Trimmed FastQ files originated here:\n## https://gannet.fish.washington.edu/Atumefaciens/20181211_metagenomics_fastqc_trimgalore/20181211_metagenomics_trimgalore_03\n\n# Exit script if any command fails\nset -e\n\n# Load Python Mox module for Python module availability\n\nmodule load intel-python3_2017\n\n# SegFault fix?\nexport THREADS_DAEMON_MODEL=1\n\n# Document programs in PATH (primarily for program version ID)\n\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\n\n\n# Program paths\ndiamond=/gscratch/srlab/programs/diamond-0.9.26/diamond\nmeganizer=/gscratch/srlab/programs/MEGAN6/tools/daa-meganizer\n\n# DIAMOND NCBI nr database\ndmnd=/gscratch/srlab/blastdbs/ncbi-nr-20190925/nr.dmnd\n\n# MEGAN mapping files\nprot_acc2tax=/gscratch/srlab/sam/data/databases/MEGAN/prot_acc2tax-Jul2019X1.abin\nacc2interpro=/gscratch/srlab/sam/data/databases/MEGAN/acc2interpro-Jul2019X.abin\nacc2eggnog=/gscratch/srlab/sam/data/databases/MEGAN/acc2eggnog-Jul2019X.abin\n\n# FastQ files directory\nfastq_dir=/gscratch/srlab/sam/data/metagenomics/P_generosa\n\n\n# Loop through FastQ files, log filenames to fastq_list.txt.\n# Run DIAMOND on each FastQ\n# Run MEGANIZER on each DIAMOND output file\nfor fastq in ${fastq_dir}*.fq.gz\ndo\n\t# Log input FastQs\n\techo \"${fastq}\" >> fastq_list.txt\n\n\t# Strip leading path and extensions\n\tno_path=$(echo \"${fastq##*/}\")\n\tno_ext=$(echo \"${no_path%%.*}\")\n\n\t# Run DIAMOND with blastx\n\t${diamond} blastx \\\n\t--db ${dmnd} \\\n\t--query \"${fastq}\" \\\n\t--out \"${no_ext}\".blastx.daa \\\n\t--outfmt 100 \\\n\t--top 5 \\\n\t--block-size 15.0 \\\n\t--index-chunks 4\ndone\n```\n\nAfter running DIAMOND, the output files were \"MEGANized\" to add taxonomy/functional info to them. This will make them ready to open directly in MEGAN6. MEGANization was performed on my computer (swoose) due to the need for the MEGAN6 software to launch an X11 window (I believe this is somehow tied to a graphical user interface), which breaks the Java commands when run on Mox. Frustratingly, even though Java throws an exception, the exception doesn't appear to kill the program, which prevents Mox from knowing that the job has failed - it will just sit until the job times out! So, I didn't realize this wasn't working on Mox for a few days...\n\nUsed the following taxonomy mapping files available from the [MEGAN6 Download Page](https://software-ab.informatik.uni-tuebingen.de/download/megan6/welcome.html):\n\n- [Protein accession to NCBI-taxonomy mapping file](http://ab.inf.uni-tuebingen.de/data/software/megan6/download/prot_acc2tax-Jul2019X1.abin.zip)\n\n- [Protein accession to InterPro mapping file](http://ab.inf.uni-tuebingen.de/data/software/megan6/download/acc2interpro-Jul2019X.abin.zip)\n\n- [Protein accession to eggNOG mapping file](http://ab.inf.uni-tuebingen.de/data/software/megan6/download/acc2eggnog-Jul2019X.abin.zip)\n\nMEGANIZER script (GitHub):\n\n- [20191007_metagenomics_meganizer.sh](https://github.com/RobertsLab/sams-notebook/blob/master/bash_scripts/20191007_metagenomics_meganizer.sh)\n\n```shell\n#!/bin/bash\n\n# Script to run MEGAN6 meganizer on DIAMOND DAA files from\n# 20190925_metagenomics_DIAMOND_blastx Mox job.\n\n# Requires MEGAN mapping files from:\n# http://ab.inf.uni-tuebingen.de/data/software/megan6/download\n\n# Program path\nmeganizer=/home/sam/programs/megan/tools/daa-meganizer\n\n# MEGAN mapping files\nprot_acc2tax=/home/sam/data/databases/MEGAN/prot_acc2tax-Jul2019X1.abin\nacc2interpro=/home/sam/data/databases/MEGAN/acc2interpro-Jul2019X.abin\nacc2eggnog=/home/sam/data/databases/MEGAN/acc2eggnog-Jul2019X.abin\n\n# Run MEGANIZER\nfor daa in *.daa\ndo\n  ${meganizer} \\\n  --in \"${daa}\" \\\n  --acc2taxa ${prot_acc2tax} \\\n  --acc2interpro2go ${acc2interpro} \\\n  --acc2eggnog ${acc2eggnog}\ndone\n```\n\n---\n\n# RESULTS\n\nThe initial DIAMOND BLASTx took ~12hrs per sample, for a total run time of ~5 days:\n\n![Screencap of DIAMONDA BLASTx Mox runtime](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20190925_metagenomics_DIAMOND_blastx_runtime.png?raw=true)\n\n\n\nOutput folder:\n\n- [20190925_metagenomics_DIAMOND_blastx/](https://gannet.fish.washington.edu/Atumefaciens/20190925_metagenomics_DIAMOND_blastx/)\n\nAll `.daa` files should now be able to be loaded into MEGAN6 for taxonomic analyses.\n","srcMarkdownNoYaml":"\nWe recently had a meeting with Emma and Brook about the progress of this metagenomics project and Brook suggested trying out [MEGAN6](https://ab.inf.uni-tuebingen.de/software/megan6) as user-friendly way to get these samples annotated.\n\nAlthough [MEGAN6](https://ab.inf.uni-tuebingen.de/software/megan6) will accept BLAST output as input, it has to be formatted in a certain way. Although I've previously BLASTed these data, the outputs of those were not formatted in a way that is readily able to be imported into MEGAN6, so instead I opted to re-BLAST these using [DIAMOND](https://github.com/bbuchfink/diamond) (which is produced by the same group that created MEGAN6), as it is significantly faster than BLASTx and has output formats that are geared towards import to MEGAN6.\n\nI downloaded the NCBI nr BLASTdb in FastA format:\n\n`ftp://ftp.ncbi.nih.gov/blast/db/FASTA/nr.gz`\n\nI prepared the DIAMOND BLASTdb (`nr.dmnd`) with the following command:\n\n```shell\n/gscratch/srlab/programs/diamond-0.9.26/diamond makedb \\\n--in nr.faa \\\n-d nr \\\n--taxonmap prot.accession2taxid \\\n--taxonnodes nodes.dmp\n```\nThe taxonmap and taxon node files were downloaded from the following NCBI locations:\n\n- `ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/accession2taxid/prot.accession2taxid.gz`\n\n- `ftp://ftp.ncbi.nlm.nih.gov/pub/taxonomy/taxdmp.zip`\n\n\nSBATCH script (GitHub):\n\n- [20190923_pgen_fastp_EPI_trimming.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20190923_pgen_fastp_EPI_trimming.sh)\n\n```shell\n#!/bin/bash\n## Job Name\n#SBATCH --job-name=metagenomics_DIAMOND\n## Allocation Definition\n#SBATCH --account=coenv\n#SBATCH --partition=coenv\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=6-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20190925_metagenomics_DIAMOND_blastx\n\n## Perform DIAMOND BLASTx on trimmed geoduck water metagnomics FastQ files,\n## and prepare them for analysis in MEGAN6 by running daa-meganizer on them.\n## Trimmed FastQ files originated here:\n## https://gannet.fish.washington.edu/Atumefaciens/20181211_metagenomics_fastqc_trimgalore/20181211_metagenomics_trimgalore_03\n\n# Exit script if any command fails\nset -e\n\n# Load Python Mox module for Python module availability\n\nmodule load intel-python3_2017\n\n# SegFault fix?\nexport THREADS_DAEMON_MODEL=1\n\n# Document programs in PATH (primarily for program version ID)\n\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\n\n\n# Program paths\ndiamond=/gscratch/srlab/programs/diamond-0.9.26/diamond\nmeganizer=/gscratch/srlab/programs/MEGAN6/tools/daa-meganizer\n\n# DIAMOND NCBI nr database\ndmnd=/gscratch/srlab/blastdbs/ncbi-nr-20190925/nr.dmnd\n\n# MEGAN mapping files\nprot_acc2tax=/gscratch/srlab/sam/data/databases/MEGAN/prot_acc2tax-Jul2019X1.abin\nacc2interpro=/gscratch/srlab/sam/data/databases/MEGAN/acc2interpro-Jul2019X.abin\nacc2eggnog=/gscratch/srlab/sam/data/databases/MEGAN/acc2eggnog-Jul2019X.abin\n\n# FastQ files directory\nfastq_dir=/gscratch/srlab/sam/data/metagenomics/P_generosa\n\n\n# Loop through FastQ files, log filenames to fastq_list.txt.\n# Run DIAMOND on each FastQ\n# Run MEGANIZER on each DIAMOND output file\nfor fastq in ${fastq_dir}*.fq.gz\ndo\n\t# Log input FastQs\n\techo \"${fastq}\" >> fastq_list.txt\n\n\t# Strip leading path and extensions\n\tno_path=$(echo \"${fastq##*/}\")\n\tno_ext=$(echo \"${no_path%%.*}\")\n\n\t# Run DIAMOND with blastx\n\t${diamond} blastx \\\n\t--db ${dmnd} \\\n\t--query \"${fastq}\" \\\n\t--out \"${no_ext}\".blastx.daa \\\n\t--outfmt 100 \\\n\t--top 5 \\\n\t--block-size 15.0 \\\n\t--index-chunks 4\ndone\n```\n\nAfter running DIAMOND, the output files were \"MEGANized\" to add taxonomy/functional info to them. This will make them ready to open directly in MEGAN6. MEGANization was performed on my computer (swoose) due to the need for the MEGAN6 software to launch an X11 window (I believe this is somehow tied to a graphical user interface), which breaks the Java commands when run on Mox. Frustratingly, even though Java throws an exception, the exception doesn't appear to kill the program, which prevents Mox from knowing that the job has failed - it will just sit until the job times out! So, I didn't realize this wasn't working on Mox for a few days...\n\nUsed the following taxonomy mapping files available from the [MEGAN6 Download Page](https://software-ab.informatik.uni-tuebingen.de/download/megan6/welcome.html):\n\n- [Protein accession to NCBI-taxonomy mapping file](http://ab.inf.uni-tuebingen.de/data/software/megan6/download/prot_acc2tax-Jul2019X1.abin.zip)\n\n- [Protein accession to InterPro mapping file](http://ab.inf.uni-tuebingen.de/data/software/megan6/download/acc2interpro-Jul2019X.abin.zip)\n\n- [Protein accession to eggNOG mapping file](http://ab.inf.uni-tuebingen.de/data/software/megan6/download/acc2eggnog-Jul2019X.abin.zip)\n\nMEGANIZER script (GitHub):\n\n- [20191007_metagenomics_meganizer.sh](https://github.com/RobertsLab/sams-notebook/blob/master/bash_scripts/20191007_metagenomics_meganizer.sh)\n\n```shell\n#!/bin/bash\n\n# Script to run MEGAN6 meganizer on DIAMOND DAA files from\n# 20190925_metagenomics_DIAMOND_blastx Mox job.\n\n# Requires MEGAN mapping files from:\n# http://ab.inf.uni-tuebingen.de/data/software/megan6/download\n\n# Program path\nmeganizer=/home/sam/programs/megan/tools/daa-meganizer\n\n# MEGAN mapping files\nprot_acc2tax=/home/sam/data/databases/MEGAN/prot_acc2tax-Jul2019X1.abin\nacc2interpro=/home/sam/data/databases/MEGAN/acc2interpro-Jul2019X.abin\nacc2eggnog=/home/sam/data/databases/MEGAN/acc2eggnog-Jul2019X.abin\n\n# Run MEGANIZER\nfor daa in *.daa\ndo\n  ${meganizer} \\\n  --in \"${daa}\" \\\n  --acc2taxa ${prot_acc2tax} \\\n  --acc2interpro2go ${acc2interpro} \\\n  --acc2eggnog ${acc2eggnog}\ndone\n```\n\n---\n\n# RESULTS\n\nThe initial DIAMOND BLASTx took ~12hrs per sample, for a total run time of ~5 days:\n\n![Screencap of DIAMONDA BLASTx Mox runtime](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20190925_metagenomics_DIAMOND_blastx_runtime.png?raw=true)\n\n\n\nOutput folder:\n\n- [20190925_metagenomics_DIAMOND_blastx/](https://gannet.fish.washington.edu/Atumefaciens/20190925_metagenomics_DIAMOND_blastx/)\n\nAll `.daa` files should now be able to be loaded into MEGAN6 for taxonomic analyses.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"toc-depth":5,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"title-block-banner":true,"author":"Sam White","toc-title":"Contents","toc-location":"left","layout":"post","title":"Metagenomics Annotation - P.generosa Water Samples Using DIAMOND BLASTx on Mox","date":"2019-09-25 14:34","tags":["Panopea generosa","geoduck","metagenomics","DIAMOND","mox","MEGAN6"],"categories":["2019","Miscellaneous"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}