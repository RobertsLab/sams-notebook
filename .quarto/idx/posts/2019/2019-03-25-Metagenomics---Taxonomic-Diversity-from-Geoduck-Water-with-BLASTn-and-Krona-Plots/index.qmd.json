{"title":"Metagenomics - Taxonomic Diversity from Geoduck Water with BLASTn and Krona Plots","markdown":{"yaml":{"author":"Sam White","toc-title":"Contents","toc-depth":5,"toc-location":"left","layout":"post","title":"Metagenomics - Taxonomic Diversity from Geoduck Water with BLASTn and Krona Plots","date":"2019-03-25 20:26","tags":["geoduck","Panopea generosa","blastn","krona","metagenomics"],"categories":["2019","Miscellaneous"]},"headingText":"Job Name","containsRefs":false,"markdown":"\nContinuing on getting the metagenomics sequencing project written up as a manuscript, Steven asked me to provide an overview of the taxonomic makeup of our metagenome assembly in this [GitHub Issue](https://github.com/RobertsLab/resources/issues/547). Earlier today, I [ran analysis using BLASTp data](https://robertslab.github.io/sams-notebook/posts/2019/2019-03-25-Metagenomics---Taxonomic-Diversity-from-Geoduck-Water-with-BLASTp-and-Krona-plots/). I initiated additional analysis using the MetaGeneMark nucleotide data to run BLASTn on Mox.\n\n- [20190103-mgm-nucleotides.fa](http://gannet.fish.washington.edu/Atumefaciens/20190103_metagenomics_geo_metagenemark/20190103-mgm-nucleotides.fa) (1.6GB)\n\nHere's how the sample names breakdown:\n\n| Sample | Develomental Stage (days post-fertilization) | pH Treatment |\n|--------|-------------------------|--------------|\n| MG1    | 13                      | 8.2          |\n| MG2    | 17                      | 8.2          |\n| MG3    | 6                       | 7.1          |\n| MG5    | 10                      | 8.2          |\n| MG6    | 13                      | 7.1          |\n| MG7    | 17                      | 7.1          |\n\nSBATCH script:\n\n- [20190325_blastn_metagenomics_geoduck_metagenemark.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20190325_blastn_metagenomics_geoduck_metagenemark.sh)\n\n<pre><code>\n#!/bin/bash\n#SBATCH --job-name=blastn_metagenomics\n## Allocation Definition\n#SBATCH --account=coenv\n#SBATCH --partition=coenv\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=25-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --workdir=/gscratch/scrubbed/samwhite/outputs/20190325_blastn_metagenomics_geoduck_metagenemark\n\n# Load Python Mox module for Python module availability\n\nmodule load intel-python3_2017\n\n# Document programs in PATH (primarily for program version ID)\n\ndate >> system_path.log\necho \"\" >> system_path.log\necho \"System PATH for $SLURM_JOB_ID\" >> system_path.log\necho \"\" >> system_path.log\nprintf \"%0.s-\" {1..10} >> system_path.log\necho ${PATH} | tr : \\\\n >> system_path.log\n\n\nwd=\"$(pwd)\"\n\n\n# Paths to input/output files\nblastn_out=\"${wd}/blastn.outfmt6\"\nblastdb_dir=\"/gscratch/srlab/blastdbs/ncbi-nr-nt-v5\"\nblast_db=\"${blastdb_dir}/nt\"\nfasta=\"/gscratch/srlab/sam/data/metagenomics/P_generosa/assemblies/20190103-mgm-nucleotides.fa\"\n\n# Paths to programs\nblast_dir=\"/gscratch/srlab/programs/ncbi-blast-2.8.1+/bin\"\nblastn=\"${blast_dir}/blastn\"\n\nexport BLASTDB=${blastdb_dir}\n\n# Run blastx on Trinity fasta\n${blastn} \\\n-query ${fasta} \\\n-db ${blast_db} \\\n-max_target_seqs 1 \\\n-outfmt \"6 std staxids\" \\\n-evalue 1e-10 \\\n-num_threads 28 \\\n> ${blastn_out}\n\n</code></pre>\n\n\nAfter the BLASTn, I followed that up by making a Krona plot using the taxonomic info pulled via BLASTn. This was run locally on my computer (swoose).\n\nKrona plot script:\n\n- [krona_tax_plots_blast.sh](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/krona_tax_plots_blast.sh)\n\n\n<pre><code>\n#!/bin/env bash\n\n# Bash script for creating Krona plot of metagenomics taxonomies from BLAST outputs.\n\n# BLAST output format is expected to be: \"6 std staxids\"\n\n# Input/output files\nblast_out=\"blastn.outfmt6\"\nkrona_out=\"krona_megahit_MGM_blastn.html\"\nkrona_tax_list=\"krona_tax.lst\"\nkrona_stderr=\"krona_stderr.txt\" # Krona standard error capture\nkrona_stdout=\"krona_stdout.txt\" # Krona standard out capture\n\n# Programs\nkrona=\"/home/sam/programs/KronaTools-2.7/bin/ktImportTaxonomy\"\n\n## Extract NCBI taxon IDs from BLAST output\n### Uses awk associative array to pull out unique entries with highest bitscore and unqique NCBI tax IDs\n### BLAST output is sorted by bitscore for multiple matches for a single query\n### Pipe unique entries to second awk command\n### Set ';' and tab as field delimiters. Prevents issues with taxon ID column having multiple entries for multi-strain matching\n### Prints a tab-delimited ouptut file containing the query ID and the taxon ID\nawk -F'[;\\t]' '!seen[$1,$13]++' ${blast_out} \\\n| awk '{print $1 \"\\t\" $13}' \\\n> ${krona_tax_list}\n\n## Create Krona plot, specifying output filename\n${krona} \\\n-o ${krona_out} \\\n${krona_tax_list} \\\n1> ${krona_stdout} \\\n2> ${krona_stderr}\n\n</code></pre>\n\n---\n\n# RESULTS\n\nOutput folder:\n\n- [20190325_blastn_metagenomics_geoduck_metagenemark/](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/)\n\nBLASTn output (tab-delimited text):\n\n- [/20190325_blastn_metagenomics_geoduck_metagenemark/blastn.outfmt6](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/blastn.outfmt6)\n\nKrona plot (HTML):\n\n- [20190325_blastn_metagenomics_geoduck_metagenemark/krona_megahit_MGM_blastn.html](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/krona_megahit_MGM_blastn.html)\n\nThe BLASTn took about 6hrs to complete on Mox, using a single node. The Krona plot above is an interactive web page and provides a really nice way to dive into the taxonomic abundances of this data set.\n\nNow, time to delve into exploring differences between the different treatments in this experiment and ssee how their taxonomy compares.\n","srcMarkdownNoYaml":"\nContinuing on getting the metagenomics sequencing project written up as a manuscript, Steven asked me to provide an overview of the taxonomic makeup of our metagenome assembly in this [GitHub Issue](https://github.com/RobertsLab/resources/issues/547). Earlier today, I [ran analysis using BLASTp data](https://robertslab.github.io/sams-notebook/posts/2019/2019-03-25-Metagenomics---Taxonomic-Diversity-from-Geoduck-Water-with-BLASTp-and-Krona-plots/). I initiated additional analysis using the MetaGeneMark nucleotide data to run BLASTn on Mox.\n\n- [20190103-mgm-nucleotides.fa](http://gannet.fish.washington.edu/Atumefaciens/20190103_metagenomics_geo_metagenemark/20190103-mgm-nucleotides.fa) (1.6GB)\n\nHere's how the sample names breakdown:\n\n| Sample | Develomental Stage (days post-fertilization) | pH Treatment |\n|--------|-------------------------|--------------|\n| MG1    | 13                      | 8.2          |\n| MG2    | 17                      | 8.2          |\n| MG3    | 6                       | 7.1          |\n| MG5    | 10                      | 8.2          |\n| MG6    | 13                      | 7.1          |\n| MG7    | 17                      | 7.1          |\n\nSBATCH script:\n\n- [20190325_blastn_metagenomics_geoduck_metagenemark.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20190325_blastn_metagenomics_geoduck_metagenemark.sh)\n\n<pre><code>\n#!/bin/bash\n## Job Name\n#SBATCH --job-name=blastn_metagenomics\n## Allocation Definition\n#SBATCH --account=coenv\n#SBATCH --partition=coenv\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=25-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --workdir=/gscratch/scrubbed/samwhite/outputs/20190325_blastn_metagenomics_geoduck_metagenemark\n\n# Load Python Mox module for Python module availability\n\nmodule load intel-python3_2017\n\n# Document programs in PATH (primarily for program version ID)\n\ndate >> system_path.log\necho \"\" >> system_path.log\necho \"System PATH for $SLURM_JOB_ID\" >> system_path.log\necho \"\" >> system_path.log\nprintf \"%0.s-\" {1..10} >> system_path.log\necho ${PATH} | tr : \\\\n >> system_path.log\n\n\nwd=\"$(pwd)\"\n\n\n# Paths to input/output files\nblastn_out=\"${wd}/blastn.outfmt6\"\nblastdb_dir=\"/gscratch/srlab/blastdbs/ncbi-nr-nt-v5\"\nblast_db=\"${blastdb_dir}/nt\"\nfasta=\"/gscratch/srlab/sam/data/metagenomics/P_generosa/assemblies/20190103-mgm-nucleotides.fa\"\n\n# Paths to programs\nblast_dir=\"/gscratch/srlab/programs/ncbi-blast-2.8.1+/bin\"\nblastn=\"${blast_dir}/blastn\"\n\nexport BLASTDB=${blastdb_dir}\n\n# Run blastx on Trinity fasta\n${blastn} \\\n-query ${fasta} \\\n-db ${blast_db} \\\n-max_target_seqs 1 \\\n-outfmt \"6 std staxids\" \\\n-evalue 1e-10 \\\n-num_threads 28 \\\n> ${blastn_out}\n\n</code></pre>\n\n\nAfter the BLASTn, I followed that up by making a Krona plot using the taxonomic info pulled via BLASTn. This was run locally on my computer (swoose).\n\nKrona plot script:\n\n- [krona_tax_plots_blast.sh](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/krona_tax_plots_blast.sh)\n\n\n<pre><code>\n#!/bin/env bash\n\n# Bash script for creating Krona plot of metagenomics taxonomies from BLAST outputs.\n\n# BLAST output format is expected to be: \"6 std staxids\"\n\n# Input/output files\nblast_out=\"blastn.outfmt6\"\nkrona_out=\"krona_megahit_MGM_blastn.html\"\nkrona_tax_list=\"krona_tax.lst\"\nkrona_stderr=\"krona_stderr.txt\" # Krona standard error capture\nkrona_stdout=\"krona_stdout.txt\" # Krona standard out capture\n\n# Programs\nkrona=\"/home/sam/programs/KronaTools-2.7/bin/ktImportTaxonomy\"\n\n## Extract NCBI taxon IDs from BLAST output\n### Uses awk associative array to pull out unique entries with highest bitscore and unqique NCBI tax IDs\n### BLAST output is sorted by bitscore for multiple matches for a single query\n### Pipe unique entries to second awk command\n### Set ';' and tab as field delimiters. Prevents issues with taxon ID column having multiple entries for multi-strain matching\n### Prints a tab-delimited ouptut file containing the query ID and the taxon ID\nawk -F'[;\\t]' '!seen[$1,$13]++' ${blast_out} \\\n| awk '{print $1 \"\\t\" $13}' \\\n> ${krona_tax_list}\n\n## Create Krona plot, specifying output filename\n${krona} \\\n-o ${krona_out} \\\n${krona_tax_list} \\\n1> ${krona_stdout} \\\n2> ${krona_stderr}\n\n</code></pre>\n\n---\n\n# RESULTS\n\nOutput folder:\n\n- [20190325_blastn_metagenomics_geoduck_metagenemark/](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/)\n\nBLASTn output (tab-delimited text):\n\n- [/20190325_blastn_metagenomics_geoduck_metagenemark/blastn.outfmt6](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/blastn.outfmt6)\n\nKrona plot (HTML):\n\n- [20190325_blastn_metagenomics_geoduck_metagenemark/krona_megahit_MGM_blastn.html](http://gannet.fish.washington.edu/Atumefaciens/20190325_blastn_metagenomics_geoduck_metagenemark/krona_megahit_MGM_blastn.html)\n\nThe BLASTn took about 6hrs to complete on Mox, using a single node. The Krona plot above is an interactive web page and provides a really nice way to dive into the taxonomic abundances of this data set.\n\nNow, time to delve into exploring differences between the different treatments in this experiment and ssee how their taxonomy compares.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"toc-depth":5,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"title-block-banner":true,"author":"Sam White","toc-title":"Contents","toc-location":"left","layout":"post","title":"Metagenomics - Taxonomic Diversity from Geoduck Water with BLASTn and Krona Plots","date":"2019-03-25 20:26","tags":["geoduck","Panopea generosa","blastn","krona","metagenomics"],"categories":["2019","Miscellaneous"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}