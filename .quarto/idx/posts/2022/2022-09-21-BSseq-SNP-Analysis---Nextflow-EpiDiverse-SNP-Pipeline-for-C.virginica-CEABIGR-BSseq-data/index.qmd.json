{"title":"BSseq SNP Analysis - Nextflow EpiDiverse SNP Pipeline for C.virginica CEABIGR BSseq data","markdown":{"yaml":{"author":"Sam White","toc-title":"Contents","toc-depth":5,"toc-location":"left","layout":"post","title":"BSseq SNP Analysis - Nextflow EpiDiverse SNP Pipeline for C.virginica CEABIGR BSseq data","date":"2022-09-21 06:46","tags":["Crassostrea virginica","Eastern oyster","mox","snp","epidiverse","BSseq","ceabigr"],"categories":["2022","Miscellaneous"]},"headingText":"Job Name","containsRefs":false,"markdown":"\nSteven [asked that I identify SNPs from our _C.virginica_ CEABIGR BSseq data](https://github.com/sr320/ceabigr/issues/69) (GitHub Issue). So, I ran [sorted, deduplicated Bismark BAMs that Steven generated](https://gannet.fish.washington.edu/seashell/bu-mox/scrubbed/120321-cvBS/) through the [EpiDiverse/snp Nextflow pipeline](https://github.com/EpiDiverse/snp). The job was run on Mox.\n\n\nSBATCH script:\n\n- [20220921-cvir-ceabigr-nextflow-epidiverse-snp.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20220921-cvir-ceabigr-nextflow-epidiverse-snp.sh) (GitHub)\n\n\n```shell\n#!/bin/bash\n#SBATCH --job-name=20220921-cvir-ceabigr-nextflow-epidiverse-snp\n## Allocation Definition\n#SBATCH --account=srlab\n#SBATCH --partition=srlab\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=12-00:00:00\n## Memory per node\n#SBATCH --mem=500G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20220921-cvir-ceabigr-nextflow-epidiverse-snp\n\n# Run EpiDiverse/snp on C.virginica Bismark BAMs generated by Steven.\n# Requires a FastA file with extension: .fa\n# Requires a FastA index file to be in same directory as FastA.\n\n###################################################################################\n# These variables need to be set by user\n\n## Directory with BAM(s)\nbams_dir=\"/gscratch/scrubbed/samwhite/data/C_virginica/BSseq/120321-cvBS\"\n\n## Location of EpiDiverse/snp pipeline directory\nepi_snp=\"/gscratch/srlab/programs/epidiverse-pipelines/snp\"\n\n## FastA file is required to end with .fa\n## Requires FastA index file to be present in same directory as FastA\ngenome_fasta=\"/gscratch/srlab/sam/data/C_virginica/genomes/GCF_002022765.2_C_virginica-3.0_genomic.fa\"\n\n## Location of Nextflow\nnextflow=\"/gscratch/srlab/programs/nextflow-21.10.6-all\"\n\n## Specify desired/needed version of Nextflow\nnextflow_version=\"20.07.1\"\n\n\n###################################################################################\n\n\n# Exit script if a command fails\nset -e\n\n# Load Anaconda\n# Uknown why this is needed, but Anaconda will not run if this line is not included.\n. \"/gscratch/srlab/programs/anaconda3/etc/profile.d/conda.sh\"\n\n# Activate NF-core conda environment\nconda activate epidiverse-snp_env\n\n\n## Run EpiDiverse/snp\nNXF_VER=${nextflow_version} \\\n${nextflow} run \\\n${epi_snp} \\\n--input ${bams_dir} \\\n--reference ${genome_fasta} \\\n--variants \\\n--clusters\n\n###################################################################################\n# Capture program options\nif [[ \"${#programs_array[@]}\" -gt 0 ]]; then\n  echo \"Logging program options...\"\n  for program in \"${!programs_array[@]}\"\n  do\n    {\n    echo \"Program options for ${program}: \"\n    echo \"\"\n    # Handle samtools help menus\n    if [[ \"${program}\" == \"samtools_index\" ]] \\\n    || [[ \"${program}\" == \"samtools_sort\" ]] \\\n    || [[ \"${program}\" == \"samtools_view\" ]]\n    then\n      ${programs_array[$program]}\n\n    # Handle DIAMOND BLAST menu\n    elif [[ \"${program}\" == \"diamond\" ]]; then\n      ${programs_array[$program]} help\n\n    # Handle NCBI BLASTx menu\n    elif [[ \"${program}\" == \"blastx\" ]]; then\n      ${programs_array[$program]} -help\n    fi\n    ${programs_array[$program]} -h\n    echo \"\"\n    echo \"\"\n    echo \"----------------------------------------------\"\n    echo \"\"\n    echo \"\"\n  } &>> program_options.log || true\n\n    # If MultiQC is in programs_array, copy the config file to this directory.\n    if [[ \"${program}\" == \"multiqc\" ]]; then\n      cp --preserve ~/.multiqc_config.yaml multiqc_config.yaml\n    fi\n  done\n  echo \"Finished logging programs options.\"\n  echo \"\"\nfi\n\n\n# Document programs in PATH (primarily for program version ID)\necho \"Logging system \\$PATH...\"\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\necho \"Finished logging system $PATH.\"\n```\n\n\n---\n\n# RESULTS\n\nRun time was actually a bit longer than I was expecting (nearly two days). I think this could be shortened by adjusting some of the Nextflow config settings, as many steps seem limited to 2GB of RAM and 8CPUs for most steps. The pipeline was designed to run this type of stuff on less powerful computers, so I believe that's why those limits are there, but it's disappointing the pipeline isn't designed to scale a bit better.\n\n![Screencap of Mox emails showing start/end and a runtime of 1 day, 23hours, 6 minutes, and 36 seconds](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20220921-cvir-ceabigr-nextflow-epidiverse-snp-runtime.png?raw=true)\n\nOutput folder:\n\n- [20220921-cvir-ceabigr-nextflow-epidiverse-snp/](https://gannet.fish.washington.edu/Atumefaciens/20220921-cvir-ceabigr-nextflow-epidiverse-snp/)\n\n  #### VCFs\n\n  - [20220921-cvir-ceabigr-nextflow-epidiverse-snp/snps/vcf/](https://gannet.fish.washington.edu/Atumefaciens/20220921-cvir-ceabigr-nextflow-epidiverse-snp/snps/vcf/)\n\nClustering results look interesting (sort of?). They separate out by sex, but then there are definitely within-sex clusters:\n\n![Clustering tree generated by EpiDiverse/snp pipeline shows clear separation by sex (samples labeled as \"Xnumber[FM]) and then some additional separation within sex clusters.](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20220921-cvir-ceabigr-nextflow-epidiverse-snp-clustering_tree.png?raw=true)\n\n\nWill add links to [CEABIGR GitHub wiki](https://github.com/sr320/ceabigr/wiki/DNA-Methylation-Data-Types)\n","srcMarkdownNoYaml":"\nSteven [asked that I identify SNPs from our _C.virginica_ CEABIGR BSseq data](https://github.com/sr320/ceabigr/issues/69) (GitHub Issue). So, I ran [sorted, deduplicated Bismark BAMs that Steven generated](https://gannet.fish.washington.edu/seashell/bu-mox/scrubbed/120321-cvBS/) through the [EpiDiverse/snp Nextflow pipeline](https://github.com/EpiDiverse/snp). The job was run on Mox.\n\n\nSBATCH script:\n\n- [20220921-cvir-ceabigr-nextflow-epidiverse-snp.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20220921-cvir-ceabigr-nextflow-epidiverse-snp.sh) (GitHub)\n\n\n```shell\n#!/bin/bash\n## Job Name\n#SBATCH --job-name=20220921-cvir-ceabigr-nextflow-epidiverse-snp\n## Allocation Definition\n#SBATCH --account=srlab\n#SBATCH --partition=srlab\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=12-00:00:00\n## Memory per node\n#SBATCH --mem=500G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20220921-cvir-ceabigr-nextflow-epidiverse-snp\n\n# Run EpiDiverse/snp on C.virginica Bismark BAMs generated by Steven.\n# Requires a FastA file with extension: .fa\n# Requires a FastA index file to be in same directory as FastA.\n\n###################################################################################\n# These variables need to be set by user\n\n## Directory with BAM(s)\nbams_dir=\"/gscratch/scrubbed/samwhite/data/C_virginica/BSseq/120321-cvBS\"\n\n## Location of EpiDiverse/snp pipeline directory\nepi_snp=\"/gscratch/srlab/programs/epidiverse-pipelines/snp\"\n\n## FastA file is required to end with .fa\n## Requires FastA index file to be present in same directory as FastA\ngenome_fasta=\"/gscratch/srlab/sam/data/C_virginica/genomes/GCF_002022765.2_C_virginica-3.0_genomic.fa\"\n\n## Location of Nextflow\nnextflow=\"/gscratch/srlab/programs/nextflow-21.10.6-all\"\n\n## Specify desired/needed version of Nextflow\nnextflow_version=\"20.07.1\"\n\n\n###################################################################################\n\n\n# Exit script if a command fails\nset -e\n\n# Load Anaconda\n# Uknown why this is needed, but Anaconda will not run if this line is not included.\n. \"/gscratch/srlab/programs/anaconda3/etc/profile.d/conda.sh\"\n\n# Activate NF-core conda environment\nconda activate epidiverse-snp_env\n\n\n## Run EpiDiverse/snp\nNXF_VER=${nextflow_version} \\\n${nextflow} run \\\n${epi_snp} \\\n--input ${bams_dir} \\\n--reference ${genome_fasta} \\\n--variants \\\n--clusters\n\n###################################################################################\n# Capture program options\nif [[ \"${#programs_array[@]}\" -gt 0 ]]; then\n  echo \"Logging program options...\"\n  for program in \"${!programs_array[@]}\"\n  do\n    {\n    echo \"Program options for ${program}: \"\n    echo \"\"\n    # Handle samtools help menus\n    if [[ \"${program}\" == \"samtools_index\" ]] \\\n    || [[ \"${program}\" == \"samtools_sort\" ]] \\\n    || [[ \"${program}\" == \"samtools_view\" ]]\n    then\n      ${programs_array[$program]}\n\n    # Handle DIAMOND BLAST menu\n    elif [[ \"${program}\" == \"diamond\" ]]; then\n      ${programs_array[$program]} help\n\n    # Handle NCBI BLASTx menu\n    elif [[ \"${program}\" == \"blastx\" ]]; then\n      ${programs_array[$program]} -help\n    fi\n    ${programs_array[$program]} -h\n    echo \"\"\n    echo \"\"\n    echo \"----------------------------------------------\"\n    echo \"\"\n    echo \"\"\n  } &>> program_options.log || true\n\n    # If MultiQC is in programs_array, copy the config file to this directory.\n    if [[ \"${program}\" == \"multiqc\" ]]; then\n      cp --preserve ~/.multiqc_config.yaml multiqc_config.yaml\n    fi\n  done\n  echo \"Finished logging programs options.\"\n  echo \"\"\nfi\n\n\n# Document programs in PATH (primarily for program version ID)\necho \"Logging system \\$PATH...\"\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\necho \"Finished logging system $PATH.\"\n```\n\n\n---\n\n# RESULTS\n\nRun time was actually a bit longer than I was expecting (nearly two days). I think this could be shortened by adjusting some of the Nextflow config settings, as many steps seem limited to 2GB of RAM and 8CPUs for most steps. The pipeline was designed to run this type of stuff on less powerful computers, so I believe that's why those limits are there, but it's disappointing the pipeline isn't designed to scale a bit better.\n\n![Screencap of Mox emails showing start/end and a runtime of 1 day, 23hours, 6 minutes, and 36 seconds](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20220921-cvir-ceabigr-nextflow-epidiverse-snp-runtime.png?raw=true)\n\nOutput folder:\n\n- [20220921-cvir-ceabigr-nextflow-epidiverse-snp/](https://gannet.fish.washington.edu/Atumefaciens/20220921-cvir-ceabigr-nextflow-epidiverse-snp/)\n\n  #### VCFs\n\n  - [20220921-cvir-ceabigr-nextflow-epidiverse-snp/snps/vcf/](https://gannet.fish.washington.edu/Atumefaciens/20220921-cvir-ceabigr-nextflow-epidiverse-snp/snps/vcf/)\n\nClustering results look interesting (sort of?). They separate out by sex, but then there are definitely within-sex clusters:\n\n![Clustering tree generated by EpiDiverse/snp pipeline shows clear separation by sex (samples labeled as \"Xnumber[FM]) and then some additional separation within sex clusters.](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20220921-cvir-ceabigr-nextflow-epidiverse-snp-clustering_tree.png?raw=true)\n\n\nWill add links to [CEABIGR GitHub wiki](https://github.com/sr320/ceabigr/wiki/DNA-Methylation-Data-Types)\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"toc-depth":5,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"title-block-banner":true,"author":"Sam White","toc-title":"Contents","toc-location":"left","layout":"post","title":"BSseq SNP Analysis - Nextflow EpiDiverse SNP Pipeline for C.virginica CEABIGR BSseq data","date":"2022-09-21 06:46","tags":["Crassostrea virginica","Eastern oyster","mox","snp","epidiverse","BSseq","ceabigr"],"categories":["2022","Miscellaneous"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}