{"title":"VCF Splitting with bcftools","markdown":{"yaml":{"author":"Sam White","toc-title":"Contents","toc-depth":5,"toc-location":"left","date":"2018-10-15 13:55:44+00:00","layout":"post","slug":"vcf-splitting-with-bcftools","title":"VCF Splitting with bcftools","categories":["2018","Miscellaneous"],"tags":[".vcf","bcftools","htslib","tabix"]},"headingText":"RESULTS","containsRefs":false,"markdown":"\n\n[Steven asked for some help trying to split a VCF in to individual VCF files](https://github.com/RobertsLab/resources/issues/421).\n\nVCF file (15GB): [SNP.TRSdp5g95FnDNAmaf05.vcf.gz](https://gannet.fish.washington.edu/seashell/eog/files/VCF_files/SNP.TRSdp5g95FnDNAmaf05.vcf.gz)\n\nSkip to the Results section if you don't want to read through the tials and tribulations of getting this to work.\n\nHere's an overview of how I managed to get this to work and what didn't work.\n\n\n\n\n\n  * Installed [bcftools, htslib, and set up the bcftools plugins](https://samtools.github.io/bcftools/)\n\n\n\nFigured out the VCF file needed to be sorted, bgzipped (part of htslib), and indexed with [tabix](https://www.htslib.org/doc/tabix.html), due to the following error when initially trying to process with VCF file using bcftools:\n\n`[W::vcf_parse] contig '' is not defined in the header. (Quick workaround: index the file with tabix.)\nUndefined tags in the header, cannot proceed in the sample subset mode.`\n\nSo, I did that:\n\n\n\n\n\n  * Sort and bgzip:\n\n\n\n\n    \n    <code>cat SNP.TRSdp5g95FnDNAmaf05.vcf | \\\n    awk '$1 ~ /^#/ {print $0;next} {print $0 | \"sort -k1,1 -k2,2n\"}' | \\\n    bgzip --threads 20 > SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz</code>\n\n\n\n\n\n\n\n  * Index with tabix:\n\n\n\n\n    \n    <code>tabix --preset vcf SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz</code>\n\n\n\nThis produced a separate file:\n\n\n\n\n\n  * SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz.tbi.\n\n\n\nIt seems as though this file must exist in the same directory as the source VCF for it to be utilized, although no commands work directly with this index file.\n\nThen, tried [biostars solution](https://www.biostars.org/p/130456/#243638), but produces an error\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in *.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools view -c1 -Oz -s $sample -o ${file/.vcf*/.$sample.vcf.gz} $file\n      done\n    done\n    </code>\n\n\n\nResulting error:\n\n\n    \n    <code>[E::bcf_calc_ac] Incorrect AN/AC counts at NC_035780.1:26174</code>\n\n\n\nAnd empty split VCF files...\n\nTried tabix on unsorted bgzipped file yields this error:\n\n\n    \n    <code>[E::hts_idx_push] chromosome blocks not continuous</code>\n\n\n\nTried modified sort:\n\n\n    \n    <code>\n    cat SNP.TRSdp5g95FnDNAmaf05.vcf | \\\n    awk '$1 ~ /^#/ {print $0;next} {print $0 | \"sort -k1,1V -k2,2n\"}' | \\\n    bgzip --threads 20 > SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz\n    </code>\n\n\n\nProduces this error:\n\n\n    \n    <code>[E::bcf_calc_ac] Incorrect AN/AC counts at NC_035780.1:26174</code>\n\n\n\nAnd empty split VCF files...\n\nChanged to new version of \"view\" - trying \"call\" instead (it seems that bcftools view is deprecated?):\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in *.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools call \\\n        --consensus-caller \\\n        --output-type z \\\n        --threads 18 \\\n        --samples $sample \n        --output-file ${file/.vcf.gz/.$sample.vcf.gz} \\\n        $file\n      done\n    done\n    </code>\n\n\n\nStill results in empty output files.\n\nBased off of the repeated error about AN/AC counts, tried to fill AN/AC values...\n\n\n    \n    <code>\n    bcftools plugin fill-AN-AC SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz \\\n    --output-type z \\\n    --threads 18 \\\n    --output SNP.TRSdp5g95FnDNAmaf05.sorted.ANACfill.vcf.gz\n    </code>\n\n\n\nAnd, ran this code:\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in SNP.TRSdp5g95FnDNAmaf05.sorted.ANACfill.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools call \\\n        --consensus-caller \\\n        --output-type z \\\n        --threads 18 \\\n        --samples $sample \n        --output-file ${file/.vcf.gz/.$sample.vcf.gz} \\\n        $file\n      done\n    done\n    </code>\n\n\n\nStill results in empty files...\n\nTry original code again (expanded shortened arguments to improve readability):\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in SNP.TRSdp5g95FnDNAmaf05.sorted.ANACfill.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools view \\\n        --min-ac 1 \\\n        --output-type z \\\n        --samples $sample \\\n        --output-file ${file/.vcf*/.$sample.vcf.gz} \\\n        --threads 18 \\\n        $file\n      done\n    done\n    </code>\n\n\n\nP.S. I realize the outermost for loop is not necessary, but it was faster/easier to just quickly modify the code from that Biostars solution.\n\n\n\n* * *\n\n\n\n\n\n\n\n\nThat worked! Or, at least it is producing non-empty, split VCF files! I'll let Steven know and let him decide what impact (if any) the `fill-AN-AC` plugin had on the file(s)!\n\nBTW, running with 18 threads on my computer, this took ~30mins to split each sample into its own VCF file. However, checking performance via `htop`, it certainly does not appear to be using 18 threads...\n\nOutput folder: [20181015_vcf_split](https://gannet.fish.washington.edu/Atumefaciens/20181015_vcf_split/)\n","srcMarkdownNoYaml":"\n\n[Steven asked for some help trying to split a VCF in to individual VCF files](https://github.com/RobertsLab/resources/issues/421).\n\nVCF file (15GB): [SNP.TRSdp5g95FnDNAmaf05.vcf.gz](https://gannet.fish.washington.edu/seashell/eog/files/VCF_files/SNP.TRSdp5g95FnDNAmaf05.vcf.gz)\n\nSkip to the Results section if you don't want to read through the tials and tribulations of getting this to work.\n\nHere's an overview of how I managed to get this to work and what didn't work.\n\n\n\n\n\n  * Installed [bcftools, htslib, and set up the bcftools plugins](https://samtools.github.io/bcftools/)\n\n\n\nFigured out the VCF file needed to be sorted, bgzipped (part of htslib), and indexed with [tabix](https://www.htslib.org/doc/tabix.html), due to the following error when initially trying to process with VCF file using bcftools:\n\n`[W::vcf_parse] contig '' is not defined in the header. (Quick workaround: index the file with tabix.)\nUndefined tags in the header, cannot proceed in the sample subset mode.`\n\nSo, I did that:\n\n\n\n\n\n  * Sort and bgzip:\n\n\n\n\n    \n    <code>cat SNP.TRSdp5g95FnDNAmaf05.vcf | \\\n    awk '$1 ~ /^#/ {print $0;next} {print $0 | \"sort -k1,1 -k2,2n\"}' | \\\n    bgzip --threads 20 > SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz</code>\n\n\n\n\n\n\n\n  * Index with tabix:\n\n\n\n\n    \n    <code>tabix --preset vcf SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz</code>\n\n\n\nThis produced a separate file:\n\n\n\n\n\n  * SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz.tbi.\n\n\n\nIt seems as though this file must exist in the same directory as the source VCF for it to be utilized, although no commands work directly with this index file.\n\nThen, tried [biostars solution](https://www.biostars.org/p/130456/#243638), but produces an error\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in *.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools view -c1 -Oz -s $sample -o ${file/.vcf*/.$sample.vcf.gz} $file\n      done\n    done\n    </code>\n\n\n\nResulting error:\n\n\n    \n    <code>[E::bcf_calc_ac] Incorrect AN/AC counts at NC_035780.1:26174</code>\n\n\n\nAnd empty split VCF files...\n\nTried tabix on unsorted bgzipped file yields this error:\n\n\n    \n    <code>[E::hts_idx_push] chromosome blocks not continuous</code>\n\n\n\nTried modified sort:\n\n\n    \n    <code>\n    cat SNP.TRSdp5g95FnDNAmaf05.vcf | \\\n    awk '$1 ~ /^#/ {print $0;next} {print $0 | \"sort -k1,1V -k2,2n\"}' | \\\n    bgzip --threads 20 > SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz\n    </code>\n\n\n\nProduces this error:\n\n\n    \n    <code>[E::bcf_calc_ac] Incorrect AN/AC counts at NC_035780.1:26174</code>\n\n\n\nAnd empty split VCF files...\n\nChanged to new version of \"view\" - trying \"call\" instead (it seems that bcftools view is deprecated?):\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in *.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools call \\\n        --consensus-caller \\\n        --output-type z \\\n        --threads 18 \\\n        --samples $sample \n        --output-file ${file/.vcf.gz/.$sample.vcf.gz} \\\n        $file\n      done\n    done\n    </code>\n\n\n\nStill results in empty output files.\n\nBased off of the repeated error about AN/AC counts, tried to fill AN/AC values...\n\n\n    \n    <code>\n    bcftools plugin fill-AN-AC SNP.TRSdp5g95FnDNAmaf05.sorted.vcf.gz \\\n    --output-type z \\\n    --threads 18 \\\n    --output SNP.TRSdp5g95FnDNAmaf05.sorted.ANACfill.vcf.gz\n    </code>\n\n\n\nAnd, ran this code:\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in SNP.TRSdp5g95FnDNAmaf05.sorted.ANACfill.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools call \\\n        --consensus-caller \\\n        --output-type z \\\n        --threads 18 \\\n        --samples $sample \n        --output-file ${file/.vcf.gz/.$sample.vcf.gz} \\\n        $file\n      done\n    done\n    </code>\n\n\n\nStill results in empty files...\n\nTry original code again (expanded shortened arguments to improve readability):\n\n\n    \n    <code>\n    #!/bin/bash\n    for file in SNP.TRSdp5g95FnDNAmaf05.sorted.ANACfill.vcf.gz; do\n      for sample in `bcftools query -l $file`; do\n        bcftools view \\\n        --min-ac 1 \\\n        --output-type z \\\n        --samples $sample \\\n        --output-file ${file/.vcf*/.$sample.vcf.gz} \\\n        --threads 18 \\\n        $file\n      done\n    done\n    </code>\n\n\n\nP.S. I realize the outermost for loop is not necessary, but it was faster/easier to just quickly modify the code from that Biostars solution.\n\n\n\n* * *\n\n\n\n\n\n# RESULTS\n\n\n\nThat worked! Or, at least it is producing non-empty, split VCF files! I'll let Steven know and let him decide what impact (if any) the `fill-AN-AC` plugin had on the file(s)!\n\nBTW, running with 18 threads on my computer, this took ~30mins to split each sample into its own VCF file. However, checking performance via `htop`, it certainly does not appear to be using 18 threads...\n\nOutput folder: [20181015_vcf_split](https://gannet.fish.washington.edu/Atumefaciens/20181015_vcf_split/)\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"toc-depth":5,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"title-block-banner":true,"author":"Sam White","toc-title":"Contents","toc-location":"left","date":"2018-10-15 13:55:44+00:00","layout":"post","slug":"vcf-splitting-with-bcftools","title":"VCF Splitting with bcftools","categories":["2018","Miscellaneous"],"tags":[".vcf","bcftools","htslib","tabix"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}