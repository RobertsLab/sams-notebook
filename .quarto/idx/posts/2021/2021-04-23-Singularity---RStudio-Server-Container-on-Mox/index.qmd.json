{"title":"Singularity - RStudio Server Container on Mox","markdown":{"yaml":{"author":"Sam White","toc-title":"Contents","toc-depth":5,"toc-location":"left","layout":"post","title":"Singularity - RStudio Server Container on Mox","date":"2021-04-23 10:18","categories":["computing","Rstudio Server","mox","singularity","2021","Miscellaneous"]},"containsRefs":false,"markdown":"\n[Aidan recently needed to use R on a machine with more memory](https://github.com/RobertsLab/resources/discussions/1180). Additionally, it would be ideal if he could use RStudio. So, I managed to figure out how to set up a Singularity container running [rocker/rstudio](https://github.com/rocker-org/rocker).\n\nFor those of you not interested in the process, just jump over to our [handbook guide on how to use the container to run RStudio Server on Mox (or, build your own)](https://robertslab.github.io/resources/mox_RStudio-Server/).\n\nNow, for the lengthy, and probably unneccessary, parts... Sometimes it's useful to document the pain. \n\nThe UW high-perfomance computing (HPC) cluster, Hyak, used to have an RStudio Server module installed, as well as instructions on how to get it going. However, that module no longer exists, so wasn't usable. I hit up UW IT and they directed me to this [Rocker SLURM job example.](https://www.rocker-project.org/use/singularity/).  After a few different attempts to get this work, I finally found someone else who's had the same issue! \n\nI created a [functional SLURM script modified from this GitHub Issue](https://github.com/rocker-org/rocker-versioned2/issues/105#issuecomment-799848638) and it totally worked! Except, due to the fact that a SLURM script is run on a [execute/compute node on Mox](https://robertslab.github.io/resources/mox_Node-Types/#execute-node), there's no internet access; which means no installing new packages via RStudio Server when it's running on Mox. Although I haven't documented it yet, I was unable to get this to work on [build node on Mox](https://robertslab.github.io/resources/mox_Node-Types/#build-node) (which _does_ have internet access) because parts of the process require the use of `sudo` which isn't available on Mox.\n\nSo, I turned to installing Singularity on my own computer and building/updating the container locally. Singularity installation didn't go as smoothly as I would've hoped, but I eventually found this [Singularity installation guide](https://github.com/hpcng/singularity/issues/4765#issuecomment-814564188) (GitHub Issue) which took care of any issues I had encountered.\n\nTo retrieve the container from Rocker _and make it accessible_, I needed to build it as a sandbox. The command below also specifies to pull Rstudio with R v4.0.2.\n\n`singularity build --sandbox rstudio-4.0.2.sandbox.simg docker://rocker/rstudio:4.0.2`\n\nFrom here, I learned how to get into the container, which would potentially allow me to update/install system and R packages, but you need root access inside the container. To get that, I ran:\n\n`sudo singularity shell rstudio-4.0.2.sandbox.simg/`\n\n![screenshot showing differences in singularity with/without sudo](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_root.png?raw=true)\n\nI also quickly learned that the container needs to be writable:\n\n![screenshot of not writable](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_root-not-enough.png?raw=true)\n\n![screenshot of writable](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_root-writable.png?raw=true)\n\nAfter making some feeble attempt to install some R packages, I encountered a number of errors indicating missing system packages. Those were installed via the shell in the container:\n\nInstall libbz2:\n\n`apt install libbz2-dev`\n\nInstall liblzma:\n\n`apt install liblzma-dev`\n\nInstall libxml2\n\n`apt install libxml2`\n\nInstall libz-dev\n\n`apt install libz-dev`\n\nInstall libxtst6 to allow R Markdown image rendering:\n\n`apt install libxtst6`\n\nAfter resolving those issues, I could start R and install stuff:\n\nBioConductor:\n\n```R\nif (!requireNamespace(\"BiocManager\", quietly = TRUE))\n    install.packages(\"BiocManager\")\nBiocManager::install(version = \"3.12\")\n```\n\nDESeq2:\n\n```R\nBiocManager::install(\"DESeq2\")\n```\n\nErrors:\n\n![first error](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_deseq2-delayedarray.png?raw=true)\n\n![second error](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_deseq2-matrixgenerics.png?raw=true)\n\nMatrixGenerics:\n\n```R\nBiocManager::install(\"MatrixGenerics\")\n```\n\nError:\n\n![matrixStats version too old](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_deseq2-matrixstats.png?raw=true)\n\nmatrixStats:\n\n```R\ninstall.packages(\"cran.rstudio.com/src/contrib/matrixStats_0.58.0.tar.gz\", repos=NULL, type=\"source\")\n```\n\nMethylkit:\n\n```R\nBiocManager::install(\"methylKit\")\n```\n\nWGCNA:\n\n```R\nBiocManager::install(\"WGCNA\")\n```\n\ntidyverse:\n\n```R\ninstall.packages(\"tidyverse\")\n```\n\n\nAfter getting all the desired packages installed, I needed to actually build the container image. The image is a single file, whereas the sandbox representation is actually a way to interact with all the system directories.\n\n\nBuild container (from [StackOverFlow](https://stackoverflow.com/questions/60155573/how-to-export-a-container-in-singularity)):\n\n`sudo singularity build rstudio-4.0.2.sjw-01 rstudio-4.0.2.sandbox.simg/`\n\nThis container image was then rsync'd to the following Mox location for everyone to access:\n\n`/gscratch/srlab/programs/singularity_containers`\n\nThis will suffice for now to allow people to play around/test/use it for some things. However, there are other things I'd like to work on:\n\n- Ideally, get this set up to be able to build containers on a Mox build node.\n\n- Get Singularity installed on one of the birds (e.g. Emu, Roadrunner) so that people can build their own containers. Singularity is only available for Linux, thus most other lab members won't be able to use their own computers to build containers; they'll need one of the birds which run Ubuntu.\n","srcMarkdownNoYaml":"\n[Aidan recently needed to use R on a machine with more memory](https://github.com/RobertsLab/resources/discussions/1180). Additionally, it would be ideal if he could use RStudio. So, I managed to figure out how to set up a Singularity container running [rocker/rstudio](https://github.com/rocker-org/rocker).\n\nFor those of you not interested in the process, just jump over to our [handbook guide on how to use the container to run RStudio Server on Mox (or, build your own)](https://robertslab.github.io/resources/mox_RStudio-Server/).\n\nNow, for the lengthy, and probably unneccessary, parts... Sometimes it's useful to document the pain. \n\nThe UW high-perfomance computing (HPC) cluster, Hyak, used to have an RStudio Server module installed, as well as instructions on how to get it going. However, that module no longer exists, so wasn't usable. I hit up UW IT and they directed me to this [Rocker SLURM job example.](https://www.rocker-project.org/use/singularity/).  After a few different attempts to get this work, I finally found someone else who's had the same issue! \n\nI created a [functional SLURM script modified from this GitHub Issue](https://github.com/rocker-org/rocker-versioned2/issues/105#issuecomment-799848638) and it totally worked! Except, due to the fact that a SLURM script is run on a [execute/compute node on Mox](https://robertslab.github.io/resources/mox_Node-Types/#execute-node), there's no internet access; which means no installing new packages via RStudio Server when it's running on Mox. Although I haven't documented it yet, I was unable to get this to work on [build node on Mox](https://robertslab.github.io/resources/mox_Node-Types/#build-node) (which _does_ have internet access) because parts of the process require the use of `sudo` which isn't available on Mox.\n\nSo, I turned to installing Singularity on my own computer and building/updating the container locally. Singularity installation didn't go as smoothly as I would've hoped, but I eventually found this [Singularity installation guide](https://github.com/hpcng/singularity/issues/4765#issuecomment-814564188) (GitHub Issue) which took care of any issues I had encountered.\n\nTo retrieve the container from Rocker _and make it accessible_, I needed to build it as a sandbox. The command below also specifies to pull Rstudio with R v4.0.2.\n\n`singularity build --sandbox rstudio-4.0.2.sandbox.simg docker://rocker/rstudio:4.0.2`\n\nFrom here, I learned how to get into the container, which would potentially allow me to update/install system and R packages, but you need root access inside the container. To get that, I ran:\n\n`sudo singularity shell rstudio-4.0.2.sandbox.simg/`\n\n![screenshot showing differences in singularity with/without sudo](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_root.png?raw=true)\n\nI also quickly learned that the container needs to be writable:\n\n![screenshot of not writable](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_root-not-enough.png?raw=true)\n\n![screenshot of writable](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_root-writable.png?raw=true)\n\nAfter making some feeble attempt to install some R packages, I encountered a number of errors indicating missing system packages. Those were installed via the shell in the container:\n\nInstall libbz2:\n\n`apt install libbz2-dev`\n\nInstall liblzma:\n\n`apt install liblzma-dev`\n\nInstall libxml2\n\n`apt install libxml2`\n\nInstall libz-dev\n\n`apt install libz-dev`\n\nInstall libxtst6 to allow R Markdown image rendering:\n\n`apt install libxtst6`\n\nAfter resolving those issues, I could start R and install stuff:\n\nBioConductor:\n\n```R\nif (!requireNamespace(\"BiocManager\", quietly = TRUE))\n    install.packages(\"BiocManager\")\nBiocManager::install(version = \"3.12\")\n```\n\nDESeq2:\n\n```R\nBiocManager::install(\"DESeq2\")\n```\n\nErrors:\n\n![first error](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_deseq2-delayedarray.png?raw=true)\n\n![second error](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_deseq2-matrixgenerics.png?raw=true)\n\nMatrixGenerics:\n\n```R\nBiocManager::install(\"MatrixGenerics\")\n```\n\nError:\n\n![matrixStats version too old](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20210423_singularity_rstudio_deseq2-matrixstats.png?raw=true)\n\nmatrixStats:\n\n```R\ninstall.packages(\"cran.rstudio.com/src/contrib/matrixStats_0.58.0.tar.gz\", repos=NULL, type=\"source\")\n```\n\nMethylkit:\n\n```R\nBiocManager::install(\"methylKit\")\n```\n\nWGCNA:\n\n```R\nBiocManager::install(\"WGCNA\")\n```\n\ntidyverse:\n\n```R\ninstall.packages(\"tidyverse\")\n```\n\n\nAfter getting all the desired packages installed, I needed to actually build the container image. The image is a single file, whereas the sandbox representation is actually a way to interact with all the system directories.\n\n\nBuild container (from [StackOverFlow](https://stackoverflow.com/questions/60155573/how-to-export-a-container-in-singularity)):\n\n`sudo singularity build rstudio-4.0.2.sjw-01 rstudio-4.0.2.sandbox.simg/`\n\nThis container image was then rsync'd to the following Mox location for everyone to access:\n\n`/gscratch/srlab/programs/singularity_containers`\n\nThis will suffice for now to allow people to play around/test/use it for some things. However, there are other things I'd like to work on:\n\n- Ideally, get this set up to be able to build containers on a Mox build node.\n\n- Get Singularity installed on one of the birds (e.g. Emu, Roadrunner) so that people can build their own containers. Singularity is only available for Linux, thus most other lab members won't be able to use their own computers to build containers; they'll need one of the birds which run Ubuntu.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"toc-depth":5,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"title-block-banner":true,"author":"Sam White","toc-title":"Contents","toc-location":"left","layout":"post","title":"Singularity - RStudio Server Container on Mox","date":"2021-04-23 10:18","categories":["computing","Rstudio Server","mox","singularity","2021","Miscellaneous"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}