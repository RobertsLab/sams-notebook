{"title":"Transcriptome Annotation - C.bairdi Using DIAMOND BLASTx on Mox and MEGAN6 Meganizer on swoose","markdown":{"yaml":{"author":"Sam White","toc-title":"Contents","toc-depth":5,"toc-location":"left","layout":"post","title":"Transcriptome Annotation - C.bairdi Using DIAMOND BLASTx on Mox and MEGAN6 Meganizer on swoose","date":"2020-03-18 20:56","tags":["Tanner crab","RNAseq","DIAMOND","BLASTx","mox","MEGAN6","meganizer","Chionoecetes bairdi"],"categories":["2020","Tanner Crab RNAseq"]},"headingText":"Job Name","containsRefs":false,"markdown":"\n[After receiving/trimming the latest round of _C.bairdi_ RNAseq data on 20200318](https://robertslab.github.io/sams-notebook/posts/2020/2020-03-18-TrimmingQCMultiQC---C.bairdi-RNAseq-FastQ-with-fastp-on-Mox/), need to get the data ready to perform taxonomic selection of sequencing reads. To do this, I first need to run [DIAMOND BLASTx](https://github.com/bbuchfink/diamond), then \"meganize\" the output files in preparation for loading into [MEGAN6](https://uni-tuebingen.de/fakultaeten/mathematisch-naturwissenschaftliche-fakultaet/fachbereiche/informatik/lehrstuehle/algorithms-in-bioinformatics/software/megan6/), which will allow for taxonomic-specific read separation.\n\nDIAMOND BLASTx will be run on Mox. Meganization will be run on my computer (swoose), due to MEGAN6's reliance on Java X11 window (this is not available on Mox - throws an error when trying to run it).\n\nI fully anticipate this process to take a week or two (DIAMOND BLASTx will likely take a few days and read extraction will definitely take many days...)\n\nSBATCH script (GitHub):\n\n- [20200318_cbai_diamond_blastx.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20200318_cbai_diamond_blastx.sh)\n\n```shell\n#!/bin/bash\n#SBATCH --job-name=cbai_blastx_DIAMOND\n## Allocation Definition\n#SBATCH --account=coenv\n#SBATCH --partition=coenv\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=20-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20200318_cbai_diamond_blastx\n\n## Perform DIAMOND BLASTx on trimmed Chionoecetes bairdi (Tanner crab) FastQ files.\n\n# Exit script if any command fails\nset -e\n\n# Load Python Mox module for Python module availability\n\nmodule load intel-python3_2017\n\n# SegFault fix?\nexport THREADS_DAEMON_MODEL=1\n\n# Document programs in PATH (primarily for program version ID)\n\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\n\n\n\n# Program paths\ndiamond=/gscratch/srlab/programs/diamond-0.9.29/diamond\n\n# DIAMOND NCBI nr database\ndmnd=/gscratch/srlab/blastdbs/ncbi-nr-20190925/nr.dmnd\n\n# Capture program options\n{\necho \"Program options for DIAMOND: \"\necho \"\"\n\"${diamond}\" help\necho \"\"\necho \"\"\necho \"----------------------------------------------\"\necho \"\"\necho \"\"\n} &>> program_options.log || true\n\n# Trimmed FastQ files directory\nfastq_dir=/gscratch/scrubbed/samwhite/outputs/20200318_cbai_RNAseq_fastp_trimming\n\n\n# Loop through FastQ files, log filenames to fastq_list.txt.\n# Run DIAMOND on each FastQ\nfor fastq in ${fastq_dir}*fastp-trim*.fq.gz\ndo\n\t# Log input FastQs\n\techo \"${fastq}\" >> fastq_list.txt\n\n\t# Strip leading path and extensions\n\tno_path=$(echo \"${fastq##*/}\")\n\tno_ext=$(echo \"${no_path%%.*}\")\n\n\t# Run DIAMOND with blastx\n\t# Output format 100 produces a DAA binary file for use with MEGAN\n\t${diamond} blastx \\\n\t--db ${dmnd} \\\n\t--query \"${fastq}\" \\\n\t--out \"${no_ext}\".blastx.daa \\\n\t--outfmt 100 \\\n\t--top 5 \\\n\t--block-size 15.0 \\\n\t--index-chunks 4\ndone\n```\n\n---\n\nMEGANIZER script (GitHub):\n\n- [20200323_cbai_diamond_blastx_meganizer.sh](https://github.com/RobertsLab/sams-notebook/blob/master/bash_scripts/20200323_cbai_diamond_blastx_meganizer.sh)\n\n```shell\n#!/bin/bash\n\n# Script to run MEGAN6 meganizer on DIAMOND DAA files from\n# 20200318_cbai_diamond_blastx Mox job.\n\n# Requires MEGAN mapping files from:\n# http://ab.inf.uni-tuebingen.de/data/software/megan6/download\n\n# Exit script if any command fails\nset -e\n\n# Program path\nmeganizer=/home/sam/programs/megan/tools/daa2rma\n\n# MEGAN mapping files\nprot_acc2tax=/home/sam/data/databases/MEGAN/prot_acc2tax-Jul2019X1.abin\nacc2interpro=/home/sam/data/databases/MEGAN/acc2interpro-Jul2019X.abin\nacc2eggnog=/home/sam/data/databases/MEGAN/acc2eggnog-Jul2019X.abin\n\n\n## Inititalize arrays\ndaa_array_R1=()\ndaa_array_R2=()\n\n# Create array of DAA R1 files\nfor daa in *R1*.daa\ndo\n  daa_array_R1+=(\"${daa}\")\ndone\n\n# Create array of DAA R2 files\nfor daa in *R2*.daa\ndo\n  daa_array_R2+=(\"${daa}\")\ndone\n\n## Run MEGANIZER\n\n# Capture start \"time\"\n# Uses builtin bash variable called ${SECONDS}\nstart=${SECONDS}\n\nfor index in \"${!daa_array_R1[@]}\"\ndo\n  start_loop=${SECONDS}\n  sample_name=$(echo \"${daa_array_R1[index]}\" | awk -F \"_\" '{print $1}')\n\n  echo \"Now processing ${sample_name}.daa2rma.rma6\"\n  echo \"\"\n\n  # Run daa2rma with paired option\n  ${meganizer} \\\n  --paired \\\n  --in \"${daa_array_R1[index]}\" \"${daa_array_R2[index]}\" \\\n\t--acc2taxa ${prot_acc2tax} \\\n\t--acc2interpro2go ${acc2interpro} \\\n\t--acc2eggnog ${acc2eggnog} \\\n  --out \"${sample_name}\".daa2rma.rma6 \\\n  2>&1 | tee --append daa2rma_log.txt\n\n  end_loop=${SECONDS}\n  loop_runtime=$((end_loop-start_loop))\n\n\n  echo \"Finished processing ${sample_name}.daa2rma.rma6 in ${loop_runtime} seconds.\"\n  echo \"\"\n\ndone\n\n# Caputure end \"time\"\nend=${SECONDS}\n\nruntime=$((end-start))\n\n# Print MEGANIZER runtime, in seconds\n\n{\n  echo \"\"\n  echo \"---------------------\"\n  echo \"\"\n  echo \"Total runtime was: ${runtime} seconds\"\n} >> daa2rma_log.txt\n```\n\n---\n\n# RESULTS\n\nDIAMOND BLASTx took ~4.5 days:\n\n- [DIAMOND BLASTx runtime](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20200318_cbai_diamond_blastx_runtime.png?raw=true)\n\nThe subsequent conversion from DAA to RMA6 files to ~5.6 days.\n\nOutput folder:\n\n- [20200318_cbai_diamond_blastx/](https://gannet.fish.washington.edu/Atumefaciens/20200318_cbai_diamond_blastx/)\n\nThe RMA6 files can now be loaded into MEGAN6 to extract reads based on taxonomy.\n","srcMarkdownNoYaml":"\n[After receiving/trimming the latest round of _C.bairdi_ RNAseq data on 20200318](https://robertslab.github.io/sams-notebook/posts/2020/2020-03-18-TrimmingQCMultiQC---C.bairdi-RNAseq-FastQ-with-fastp-on-Mox/), need to get the data ready to perform taxonomic selection of sequencing reads. To do this, I first need to run [DIAMOND BLASTx](https://github.com/bbuchfink/diamond), then \"meganize\" the output files in preparation for loading into [MEGAN6](https://uni-tuebingen.de/fakultaeten/mathematisch-naturwissenschaftliche-fakultaet/fachbereiche/informatik/lehrstuehle/algorithms-in-bioinformatics/software/megan6/), which will allow for taxonomic-specific read separation.\n\nDIAMOND BLASTx will be run on Mox. Meganization will be run on my computer (swoose), due to MEGAN6's reliance on Java X11 window (this is not available on Mox - throws an error when trying to run it).\n\nI fully anticipate this process to take a week or two (DIAMOND BLASTx will likely take a few days and read extraction will definitely take many days...)\n\nSBATCH script (GitHub):\n\n- [20200318_cbai_diamond_blastx.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20200318_cbai_diamond_blastx.sh)\n\n```shell\n#!/bin/bash\n## Job Name\n#SBATCH --job-name=cbai_blastx_DIAMOND\n## Allocation Definition\n#SBATCH --account=coenv\n#SBATCH --partition=coenv\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=20-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20200318_cbai_diamond_blastx\n\n## Perform DIAMOND BLASTx on trimmed Chionoecetes bairdi (Tanner crab) FastQ files.\n\n# Exit script if any command fails\nset -e\n\n# Load Python Mox module for Python module availability\n\nmodule load intel-python3_2017\n\n# SegFault fix?\nexport THREADS_DAEMON_MODEL=1\n\n# Document programs in PATH (primarily for program version ID)\n\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\n\n\n\n# Program paths\ndiamond=/gscratch/srlab/programs/diamond-0.9.29/diamond\n\n# DIAMOND NCBI nr database\ndmnd=/gscratch/srlab/blastdbs/ncbi-nr-20190925/nr.dmnd\n\n# Capture program options\n{\necho \"Program options for DIAMOND: \"\necho \"\"\n\"${diamond}\" help\necho \"\"\necho \"\"\necho \"----------------------------------------------\"\necho \"\"\necho \"\"\n} &>> program_options.log || true\n\n# Trimmed FastQ files directory\nfastq_dir=/gscratch/scrubbed/samwhite/outputs/20200318_cbai_RNAseq_fastp_trimming\n\n\n# Loop through FastQ files, log filenames to fastq_list.txt.\n# Run DIAMOND on each FastQ\nfor fastq in ${fastq_dir}*fastp-trim*.fq.gz\ndo\n\t# Log input FastQs\n\techo \"${fastq}\" >> fastq_list.txt\n\n\t# Strip leading path and extensions\n\tno_path=$(echo \"${fastq##*/}\")\n\tno_ext=$(echo \"${no_path%%.*}\")\n\n\t# Run DIAMOND with blastx\n\t# Output format 100 produces a DAA binary file for use with MEGAN\n\t${diamond} blastx \\\n\t--db ${dmnd} \\\n\t--query \"${fastq}\" \\\n\t--out \"${no_ext}\".blastx.daa \\\n\t--outfmt 100 \\\n\t--top 5 \\\n\t--block-size 15.0 \\\n\t--index-chunks 4\ndone\n```\n\n---\n\nMEGANIZER script (GitHub):\n\n- [20200323_cbai_diamond_blastx_meganizer.sh](https://github.com/RobertsLab/sams-notebook/blob/master/bash_scripts/20200323_cbai_diamond_blastx_meganizer.sh)\n\n```shell\n#!/bin/bash\n\n# Script to run MEGAN6 meganizer on DIAMOND DAA files from\n# 20200318_cbai_diamond_blastx Mox job.\n\n# Requires MEGAN mapping files from:\n# http://ab.inf.uni-tuebingen.de/data/software/megan6/download\n\n# Exit script if any command fails\nset -e\n\n# Program path\nmeganizer=/home/sam/programs/megan/tools/daa2rma\n\n# MEGAN mapping files\nprot_acc2tax=/home/sam/data/databases/MEGAN/prot_acc2tax-Jul2019X1.abin\nacc2interpro=/home/sam/data/databases/MEGAN/acc2interpro-Jul2019X.abin\nacc2eggnog=/home/sam/data/databases/MEGAN/acc2eggnog-Jul2019X.abin\n\n\n## Inititalize arrays\ndaa_array_R1=()\ndaa_array_R2=()\n\n# Create array of DAA R1 files\nfor daa in *R1*.daa\ndo\n  daa_array_R1+=(\"${daa}\")\ndone\n\n# Create array of DAA R2 files\nfor daa in *R2*.daa\ndo\n  daa_array_R2+=(\"${daa}\")\ndone\n\n## Run MEGANIZER\n\n# Capture start \"time\"\n# Uses builtin bash variable called ${SECONDS}\nstart=${SECONDS}\n\nfor index in \"${!daa_array_R1[@]}\"\ndo\n  start_loop=${SECONDS}\n  sample_name=$(echo \"${daa_array_R1[index]}\" | awk -F \"_\" '{print $1}')\n\n  echo \"Now processing ${sample_name}.daa2rma.rma6\"\n  echo \"\"\n\n  # Run daa2rma with paired option\n  ${meganizer} \\\n  --paired \\\n  --in \"${daa_array_R1[index]}\" \"${daa_array_R2[index]}\" \\\n\t--acc2taxa ${prot_acc2tax} \\\n\t--acc2interpro2go ${acc2interpro} \\\n\t--acc2eggnog ${acc2eggnog} \\\n  --out \"${sample_name}\".daa2rma.rma6 \\\n  2>&1 | tee --append daa2rma_log.txt\n\n  end_loop=${SECONDS}\n  loop_runtime=$((end_loop-start_loop))\n\n\n  echo \"Finished processing ${sample_name}.daa2rma.rma6 in ${loop_runtime} seconds.\"\n  echo \"\"\n\ndone\n\n# Caputure end \"time\"\nend=${SECONDS}\n\nruntime=$((end-start))\n\n# Print MEGANIZER runtime, in seconds\n\n{\n  echo \"\"\n  echo \"---------------------\"\n  echo \"\"\n  echo \"Total runtime was: ${runtime} seconds\"\n} >> daa2rma_log.txt\n```\n\n---\n\n# RESULTS\n\nDIAMOND BLASTx took ~4.5 days:\n\n- [DIAMOND BLASTx runtime](https://github.com/RobertsLab/sams-notebook/blob/master/images/screencaps/20200318_cbai_diamond_blastx_runtime.png?raw=true)\n\nThe subsequent conversion from DAA to RMA6 files to ~5.6 days.\n\nOutput folder:\n\n- [20200318_cbai_diamond_blastx/](https://gannet.fish.washington.edu/Atumefaciens/20200318_cbai_diamond_blastx/)\n\nThe RMA6 files can now be loaded into MEGAN6 to extract reads based on taxonomy.\n"},"formats":{"html":{"identifier":{"display-name":"HTML","target-format":"html","base-format":"html"},"execute":{"fig-width":7,"fig-height":5,"fig-format":"retina","fig-dpi":96,"df-print":"default","error":false,"eval":true,"cache":null,"freeze":true,"echo":true,"output":true,"warning":true,"include":true,"keep-md":false,"keep-ipynb":false,"ipynb":null,"enabled":null,"daemon":null,"daemon-restart":false,"debug":false,"ipynb-filters":[],"ipynb-shell-interactivity":null,"plotly-connected":true,"engine":"markdown"},"render":{"keep-tex":false,"keep-typ":false,"keep-source":false,"keep-hidden":false,"prefer-html":false,"output-divs":true,"output-ext":"html","fig-align":"default","fig-pos":null,"fig-env":null,"code-fold":true,"code-overflow":"scroll","code-link":false,"code-line-numbers":false,"code-tools":false,"tbl-colwidths":"auto","merge-includes":true,"inline-includes":false,"preserve-yaml":false,"latex-auto-mk":true,"latex-auto-install":true,"latex-clean":true,"latex-min-runs":1,"latex-max-runs":10,"latex-makeindex":"makeindex","latex-makeindex-opts":[],"latex-tlmgr-opts":[],"latex-input-paths":[],"latex-output-dir":null,"link-external-icon":false,"link-external-newwindow":false,"self-contained-math":false,"format-resources":[],"notebook-links":true},"pandoc":{"standalone":true,"wrap":"none","default-image-extension":"png","to":"html","css":["../../../styles.css"],"toc":true,"toc-depth":5,"output-file":"index.html"},"language":{"toc-title-document":"Table of contents","toc-title-website":"On this page","related-formats-title":"Other Formats","related-notebooks-title":"Notebooks","source-notebooks-prefix":"Source","other-links-title":"Other Links","code-links-title":"Code Links","launch-dev-container-title":"Launch Dev Container","launch-binder-title":"Launch Binder","article-notebook-label":"Article Notebook","notebook-preview-download":"Download Notebook","notebook-preview-download-src":"Download Source","notebook-preview-back":"Back to Article","manuscript-meca-bundle":"MECA Bundle","section-title-abstract":"Abstract","section-title-appendices":"Appendices","section-title-footnotes":"Footnotes","section-title-references":"References","section-title-reuse":"Reuse","section-title-copyright":"Copyright","section-title-citation":"Citation","appendix-attribution-cite-as":"For attribution, please cite this work as:","appendix-attribution-bibtex":"BibTeX citation:","appendix-view-license":"View License","title-block-author-single":"Author","title-block-author-plural":"Authors","title-block-affiliation-single":"Affiliation","title-block-affiliation-plural":"Affiliations","title-block-published":"Published","title-block-modified":"Modified","title-block-keywords":"Keywords","callout-tip-title":"Tip","callout-note-title":"Note","callout-warning-title":"Warning","callout-important-title":"Important","callout-caution-title":"Caution","code-summary":"Code","code-tools-menu-caption":"Code","code-tools-show-all-code":"Show All Code","code-tools-hide-all-code":"Hide All Code","code-tools-view-source":"View Source","code-tools-source-code":"Source Code","tools-share":"Share","tools-download":"Download","code-line":"Line","code-lines":"Lines","copy-button-tooltip":"Copy to Clipboard","copy-button-tooltip-success":"Copied!","repo-action-links-edit":"Edit this page","repo-action-links-source":"View source","repo-action-links-issue":"Report an issue","back-to-top":"Back to top","search-no-results-text":"No results","search-matching-documents-text":"matching documents","search-copy-link-title":"Copy link to search","search-hide-matches-text":"Hide additional matches","search-more-match-text":"more match in this document","search-more-matches-text":"more matches in this document","search-clear-button-title":"Clear","search-text-placeholder":"","search-detached-cancel-button-title":"Cancel","search-submit-button-title":"Submit","search-label":"Search","toggle-section":"Toggle section","toggle-sidebar":"Toggle sidebar navigation","toggle-dark-mode":"Toggle dark mode","toggle-reader-mode":"Toggle reader mode","toggle-navigation":"Toggle navigation","crossref-fig-title":"Figure","crossref-tbl-title":"Table","crossref-lst-title":"Listing","crossref-thm-title":"Theorem","crossref-lem-title":"Lemma","crossref-cor-title":"Corollary","crossref-prp-title":"Proposition","crossref-cnj-title":"Conjecture","crossref-def-title":"Definition","crossref-exm-title":"Example","crossref-exr-title":"Exercise","crossref-ch-prefix":"Chapter","crossref-apx-prefix":"Appendix","crossref-sec-prefix":"Section","crossref-eq-prefix":"Equation","crossref-lof-title":"List of Figures","crossref-lot-title":"List of Tables","crossref-lol-title":"List of Listings","environment-proof-title":"Proof","environment-remark-title":"Remark","environment-solution-title":"Solution","listing-page-order-by":"Order By","listing-page-order-by-default":"Default","listing-page-order-by-date-asc":"Oldest","listing-page-order-by-date-desc":"Newest","listing-page-order-by-number-desc":"High to Low","listing-page-order-by-number-asc":"Low to High","listing-page-field-date":"Date","listing-page-field-title":"Title","listing-page-field-description":"Description","listing-page-field-author":"Author","listing-page-field-filename":"File Name","listing-page-field-filemodified":"Modified","listing-page-field-subtitle":"Subtitle","listing-page-field-readingtime":"Reading Time","listing-page-field-wordcount":"Word Count","listing-page-field-categories":"Categories","listing-page-minutes-compact":"{0} min","listing-page-category-all":"All","listing-page-no-matches":"No matching items","listing-page-words":"{0} words","listing-page-filter":"Filter","draft":"Draft"},"metadata":{"lang":"en","fig-responsive":true,"quarto-version":"1.6.42","editor":"source","theme":"darkly","page-layout":"full","code-background":true,"code-copy":true,"title-block-banner":true,"author":"Sam White","toc-title":"Contents","toc-location":"left","layout":"post","title":"Transcriptome Annotation - C.bairdi Using DIAMOND BLASTx on Mox and MEGAN6 Meganizer on swoose","date":"2020-03-18 20:56","tags":["Tanner crab","RNAseq","DIAMOND","BLASTx","mox","MEGAN6","meganizer","Chionoecetes bairdi"],"categories":["2020","Tanner Crab RNAseq"]},"extensions":{"book":{"multiFile":true}}}},"projectFormats":["html"]}