{
  "hash": "dc76d3e4abf871343104c60c1e14743e",
  "result": {
    "engine": "knitr",
    "markdown": "---\nauthor: Sam White\ntoc-title: Contents\ntoc-depth: 5\ntoc-location: left\ntitle: Sequencing Read Taxonomic Classification - Unmapped P.helanthoides RNA-seq Using DIAMOND-BLASTx and MEGAN6 on Mox\ndate: '2024-11-05'\ndraft: false\nengine: knitr\ncategories: \n  - \"2024\"\n  - \"MEGAN6\"\n  - \"RNAseq\"\n  - \"DIAMOND\"\n  - \"BLASTx\"\n  - \"Pycnopodia helianthoides\"\n  - \"sunflower sea star\"\n  - \"Mox\"\nimage: \"/posts/2024/2024-11-05-Sequencing-Read-Taxonomic-Classification---Unmapped-P.helanthoides-RNA-seq-Using-DIAMOND-BLASTx-and-MEGAN6-on-Mox/PSC-0519_unmapped_reads.1.blastx.meganized-all-heatmap.jpg\"\n---\n\n\n\n# INTRO\n\nIn preparation for a grant proposal involving sea star wasting disease, due in about two weeks, Steven [asked that I perform taxonomic classification on unmapped P.helanthoides RNA-seq reads](https://github.com/RobertsLab/resources/issues/2009) (GitHub Issue). Due to time constraints, and a bit of luck, I opted to run this on Mox (Mox _should_ have been decommissioned on 11/1/2024, but it's still running and being able to use Mox, which is already set up, instead of resorting to Klone, was much faster to get this going). Also, due to time constraints, Steven [suggested I run this on just a single set of reads](https://github.com/RobertsLab/resources/issues/2009#issuecomment-2457459109) (GitHub Issue comment). I opted for the following, since this analysis had already been started and was already working on these:\n\n- `PSC-0519_unmapped_reads.[12].fastq`\n\n# METHODS\n\n## DIAMOND BLASTx and MEGANization\n\nReads were [`DIAMOND`](https://github.com/bbuchfink/diamond) BLASTx'd against a previously constructed DIAMON BLAST database. After [`DIAMOND`](https://github.com/bbuchfink/diamond) BLASTx, the resulting DAA files were \"MEGANized\" in preparation for use in [MEGAN6](https://software-ab.cs.uni-tuebingen.de/download/megan6/welcome.html). Both steps were run on Mox.\n\n### SBATCH SCRIPT\n\nGitHub:\n\n- [20241105-phel-diamond-meganizer.sh](https://github.com/RobertsLab/sams-notebook/blob/master/sbatch_scripts/20241105-phel-diamond-meganizer.sh)\n\n```bash\n#!/bin/bash\n## Job Name\n#SBATCH --job-name=20241105-phel-diamond-meganizer\n## Allocation Definition\n#SBATCH --account=srlab\n#SBATCH --partition=srlab\n## Resources\n## Nodes\n#SBATCH --nodes=1\n## Walltime (days-hours:minutes:seconds format)\n#SBATCH --time=7-00:00:00\n## Memory per node\n#SBATCH --mem=120G\n##turn on e-mail notification\n#SBATCH --mail-type=ALL\n#SBATCH --mail-user=samwhite@uw.edu\n## Specify the working directory for this job\n#SBATCH --chdir=/gscratch/scrubbed/samwhite/outputs/20241105-phel-diamond-meganizer\n\n## Perform DIAMOND BLASTx on unmapped P.helanthoides RNA-seq files from Steven.\n## Will be used to view taxonomic breakdown of sequencing reads.\n\n## Expects input FastQ files to be match this pattern: *reads.[12].fastq\n\n\n###################################################################################\n# These variables need to be set by user\n\n## Assign Variables\n\nfastq_pattern='*reads.[12].fastq'\n\n# Program paths\ndiamond=/gscratch/srlab/programs/diamond-v2.1.1/diamond\nmeganizer=/gscratch/srlab/programs/MEGAN-6.22.0/tools/daa-meganizer\n\n# DIAMOND NCBI nr database\ndmnd_db=/gscratch/srlab/blastdbs/20230215-ncbi-nr/20230215-ncbi-nr.dmnd\n\n# MEGAN mapping files\nmegan_mapping_dir=/gscratch/srlab/sam/data/databases/MEGAN\nmegan_mapdb=\"${megan_mapping_dir}/megan-map-Feb2022.db\"\n\n# FastQ files directory\nfastq_dir=/gscratch/scrubbed/samwhite/data/P_helianthoides/RNAseq\n\n# CPU threads\nthreads=40\n\n# MEGAN memory limit\nmem_limit=100G\n\n# Programs associative array\ndeclare -A programs_array\nprograms_array=(\n[diamond]=\"${diamond}\" \\\n[meganizer]=\"${meganizer}\"\n)\n\n###################################################################################################\n\n# Exit script if any command fails\nset -e\n\n# Load Python Mox module for Python module availability\nmodule load intel-python3_2017\n\n\n# Loop through FastQ files, log filenames to fastq_list.txt.\n# Run DIAMOND on each FastQ, followed by \"MEGANization\"\n# DO NOT QUOTE ${fastq_pattern}\nfor fastq in \"${fastq_dir}\"/${fastq_pattern}\ndo\n\t# Log input FastQs\n    echo \"\"\n    echo \"Generating MD5 checksum for ${fastq}...\"\n\tmd5sum \"${fastq}\" | tee --append input_fastqs-checksums.md5\n    echo \"\"\n\n\t# Strip leading path ${fastq##*/} by eliminating all text up to and including last slash from the left side.\n    # Strip extensions by eliminating \".fastq.gz\" from the right side.\n\tno_path=$(echo \"${fastq##*/}\")\n\tno_ext=$(echo \"${no_path%%.fastq}\")\n\n\t# Run DIAMOND with blastx\n\t# Output format 100 produces a DAA binary file for use with MEGAN\n    echo \"Running DIAMOND BLASTx on ${fastq}.\"\n    echo \"\"\n\t\"${programs_array[diamond]}\" blastx \\\n\t--db ${dmnd_db} \\\n\t--query \"${fastq}\" \\\n\t--out \"${no_ext}\".blastx.meganized.daa \\\n\t--outfmt 100 \\\n\t--top 5 \\\n\t--block-size 15.0 \\\n\t--index-chunks 4 \\\n    --memory-limit ${mem_limit} \\\n    --threads ${threads}\n    echo \"DIAMOND BLASTx on ${fastq} complete: ${no_ext}.blastx.meganized.daa\"\n    echo \"\"\n\n    # Meganize DAA files\n    # Used for ability to import into MEGAN6\n    echo \"Now MEGANizing ${no_ext}.blastx.meganized.daa\"\n    \"${programs_array[meganizer]}\" \\\n    --in \"${no_ext}\".blastx.meganized.daa \\\n    --threads ${threads} \\\n    --mapDB ${megan_mapdb}\n    echo \"MEGANization of ${no_ext}.blastx.meganized.daa completed.\"\n    echo \"\"\n\ndone\n\n# Generate MD5 checksums\nfor file in *\ndo\n  echo \"\"\n  echo \"Generating MD5 checksums for ${file}:\"\n  md5sum \"${file}\" | tee --append checksums.md5\n  echo \"\"\ndone\n\n# Generate checksum for MEGAN database(s)\n{\n    md5sum \"${megan_mapdb}\"\n    md5sum \"${dmnd_db}\"\n} >> checksums.md5\n\n#######################################################################################################\n\n# Capture program options\nif [[ \"${#programs_array[@]}\" -gt 0 ]]; then\n  echo \"Logging program options...\"\n  for program in \"${!programs_array[@]}\"\n  do\n    {\n    echo \"Program options for ${program}: \"\n    echo \"\"\n    # Handle samtools help menus\n    if [[ \"${program}\" == \"samtools_index\" ]] \\\n    || [[ \"${program}\" == \"samtools_sort\" ]] \\\n    || [[ \"${program}\" == \"samtools_view\" ]]\n    then\n      ${programs_array[$program]}\n\n    # Handle DIAMOND BLAST menu\n    elif [[ \"${program}\" == \"diamond\" ]]; then\n      ${programs_array[$program]} help\n\n    # Handle NCBI BLASTx menu\n    elif [[ \"${program}\" == \"blastx\" ]]; then\n      ${programs_array[$program]} -help\n    fi\n    ${programs_array[$program]} -h\n    echo \"\"\n    echo \"\"\n    echo \"----------------------------------------------\"\n    echo \"\"\n    echo \"\"\n  } &>> program_options.log || true\n\n    # If MultiQC is in programs_array, copy the config file to this directory.\n    if [[ \"${program}\" == \"multiqc\" ]]; then\n      cp --preserve ~/.multiqc_config.yaml multiqc_config.yaml\n    fi\n  done\n  echo \"Finished logging programs options.\"\n  echo \"\"\nfi\n\n\n# Document programs in PATH (primarily for program version ID)\necho \"Logging system $PATH...\"\n{\ndate\necho \"\"\necho \"System PATH for $SLURM_JOB_ID\"\necho \"\"\nprintf \"%0.s-\" {1..10}\necho \"${PATH}\" | tr : \\\\n\n} >> system_path.log\necho \"Finished logging system $PATH.\"\n```\n\n## DAA to RMA Conversion\n\nResulting DAA files were converted to RMA6 format for import and analysis in MEGAN6. Due to time constraints, this was performed on Raven without a script. Command used:\n\n```bash\n/home/shared/megan-6.24.20/tools/daa2rma \\\n--in ./PSC-0519_unmapped_reads.1.blastx.meganized.daa ./PSC-0519_unmapped_reads.2.blastx.meganized.daa \\\n--mapDB ~/data/databases/MEGAN/megan-map-Feb2022.db \\\n--out ./PSC-0519_unmapped_reads.1.blastx.meganized.rma6 ./PSC-0519_unmapped_reads.2.blastx.meganized.rma6 \\\n--threads 40 2>&1 | tee --append daa2rma_log.txt\n```\n\n# RESULTS\n\nThe Mox run took just under 16hrs to complete:\n\n![Screencap showing Mox runtime of 15hrs 42mins and 41secs for DIAMOND BLASTx.](./20241105-phel-mox-runtime.png){#fig-mox_runtime fig-alt=\"Screencap showing Mox runtime of 15hrs 42mins and 41secs for DIAMOND BLASTx.\" .lightbox}\n\n\n# DISCUSSION\n\nLooking at the entire taxonomies, down to the species level, most of the reads (>1,500,000) get assigned to [_Asterias rubens_](https://en.wikipedia.org/wiki/Common_starfish) (Wikipedia), the common sea star. This is surprising, as I'm fairly certain these sequencing reads came from [_Pycnopodia helianthoides_](https://en.wikipedia.org/wiki/Sunflower_sea_star) (Wikipedia), the sunflower star. Of course, these results are also dependent upon how much sequence data in NCBI for any given species. However, with that said, reads are only assigned to a given taxonomic level based on the BLASTx results. Thus, even if a read comes from a sea star, it would (should?) _not_ get assigned to a particular species unless the BLASTx confidence was _very_ high...\n\nLooking at the highest read assignments for non-eukaryotic species, we see that of the Bacteria (7,153 reads), [_Bacillus yapensis_](https://link.springer.com/article/10.1007/s10482-019-01348-7) (Journal article website), while in Archae (17,742 reads), [_Methanocaldococcus jannaschii_](https://en.wikipedia.org/wiki/Methanocaldococcus_jannaschii) (Wikipedia) had the most reads assigned.\n\n\n![MEGAN6 taxonomic heat map of assignments down to Species level. Darkest green box shows highest numbers of reads assigned to _Asterias rubens_.](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/PSC-0519_unmapped_reads.1.blastx.meganized-all-heatmap.jpg){#fig-mox_runtime fig-alt=\"MEGAN6 taxonomic heat map of assignments down to species level. Darkest green box shows highest numbers of reads assigned to _Asterias rubens_.\" .lightbox}\n\n\n\n![MEGAN6 taxonomic heat map of assignments down to Class level. Top Class in Eukaryotes (Astroides), Bacteria (Bacilli), and Archae (Methanococci) are highlighted in yellow.](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/PSC-0519_unmapped_reads.1.blastx.meganized-class-heatmap.jpg){#fig-mox_runtime fig-alt=\"MEGAN6 taxonomic heat map of assignments down to Class level. Top Class in Eukaryotes (Astroides), Bacteria (Bacilli), and Archae (Methanococci) are highlighted in yellow.\" .lightbox}\n\n\n\n## Output files\n\nOutput directory:\n\n- [https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/)\n\n### DIAMOND BLASTX/MEGANIZER\n\nOutput files:\n\n- [`PSC-0519_unmapped_reads.1.blastx.meganized.daa`](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/PSC-0519_unmapped_reads.1.blastx.meganized.daa) (186GB)\n\n  - MD5: `1e7207fa8dc3ff15373f46c4e0c5bbb3`\n\n- [`PSC-0519_unmapped_reads.2.blastx.meganized.daa`](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/PSC-0519_unmapped_reads.2.blastx.meganized.daa) (179GB)\n\n  - MD5: `4e5514926056f0f3273b44da6c3ed7df`\n\n- [`checksums.md5`](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/checksums.md5)\n\n### RMA6\n\n- [`PSC-0519_unmapped_reads.1.blastx.meganized.rma6`](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/PSC-0519_unmapped_reads.1.blastx.meganized.rma6)\n\n  - MD5: `b5f0118056d1b3481b5533e420146728`\n\n- [`PSC-0519_unmapped_reads.2.blastx.meganized.rma6`](https://gannet.fish.washington.edu/Atumefaciens/20241105-phel-diamond-meganizer/PSC-0519_unmapped_reads.2.blastx.meganized.rma6)\n\n  - MD5: `4e88764010274baccafffe58f67134d2`\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}