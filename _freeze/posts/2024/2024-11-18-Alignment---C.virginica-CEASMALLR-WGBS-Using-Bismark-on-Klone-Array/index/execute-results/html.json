{
  "hash": "264f5909a49eca2a936c67f96a248dd7",
  "result": {
    "engine": "knitr",
    "markdown": "---\nauthor: Sam White\ntoc-title: Contents\ntoc-depth: 5\ntoc-location: left\ntitle: Alignment - C.virginica CEASMALLR WGBS Using Bismark on Klone Array\ndate: '2024-11-18'\ndraft: false\nengine: knitr\ncategories: \n  - \"2024\"\n  - \"trimming\"\n  - \"Crassostrea virginica\"\n  - \"Eastern oyster\"\n  - \"ceasmallr\"\n  - \"WGBS\"\n  - \"BS-seq\"\n  - \"Klone\"\n  - \"Bismark\"\n---\n\n\n\n# INTRO\n\nThis notebook is part of the [ceasmallr](https://github.com/sr320/ceasmallr) (GitHub repo) project, comparing DNA methylation in [_Crassostrea virginica_ (Eastern oyster)](https://en.wikipedia.org/wiki/Eastern_oyster) larvae and zygotes, via whole-genome bisulfite sequencing (WGBS).\n\nTrimming was previously [performed on 20241115](../2024-11-15-Trimming-and-QC---C.virginica-CEASMALLR-FastQs-Using-fastp-BBTools-and-FastQC-MultiQC/index.qmd) (Notebook entry).\n\nSubsequently, the trimmed reads needed to aligned to the [_Crassostrea virginica_ (Eastern oyster)](https://en.wikipedia.org/wiki/Eastern_oyster) genome, using [`Bismark`](https://github.com/FelixKrueger/Bismark). Alignments were initially performed on Raven, but were done using [trimmed reads containing errors from 20220829](../../2022/2022-08-29-FastQ-Trimming-and-QC---C.virginica-Larval-BS-seq-Data-from-Lotterhos-Lab-and-Part-of-CEABIGR-Project-Using-fastp-on-Mox/index.qmd) (Notebook entry), so needed to be re-trimmed _and_ realigned. Additionally, the alignments took nearly two _weeks_! So, we explored a different approach to speed things up by utilizing node arrays on the Univ. of Washington's HPC, Klone (Hyak).\n\nThe code originally run is here, and is still useful for those without access to HPC resources:\n\n- [02.00-bismark-bowtie2-alignment.Rmd](https://github.com/sr320/ceasmallr/blob/main/code/02.00-bismark-bowtie2-alignment.Rmd) (GitHub repo)\n\n# METHODS\n\n:::: {.callout-important}\nWhen launching the SLURM job, you can initiate the array to determine the appropriate number of nodes by using Bash calculations.\n\nThe file `fastq_pairs.txt` has to exist before execution!\n\n```bash\nsbatch --array=0-$(($$(wc -l < fastq_pairs.txt) - 1)) 02.02-bismark-SLURM-job.sh\n```\n\n:::\n\nThis approach required two scripts:\n\n- SLURM script\n\n  - [02.02-bismark-SLURM-job.sh](https://github.com/sr320/ceasmallr/blob/main/code/02.02-bismark-SLURM-job.sh)\n\n  ```bash\n  #!/bin/bash\n  #SBATCH --job-name=bismark_job_array\n  #SBATCH --account=coenv\n  #SBATCH --partition=cpu-g2\n  #SBATCH --output=bismark_job_%A_%a.out\n  #SBATCH --error=bismark_job_%A_%a.err\n  #SBATCH --ntasks=1\n  #SBATCH --cpus-per-task=20\n  #SBATCH --mem=100G\n  #SBATCH --time=72:00:00\n  ##turn on e-mail notification\n  #SBATCH --mail-type=ALL\n  #SBATCH --mail-user=samwhite@uw.edu\n  ## Specify the working directory for this job\n  #SBATCH --chdir=/gscratch/scrubbed/samwhite/gitrepos/ceasmallr/output/02.01-bismark-bowtie2-alignment-SLURM-array/\n  \n  # Execute Roberts Lab bioinformatics container\n  # Binds home directory\n  # Binds /gscratch directory\n  # Directory bindings allow outputs to be written to the hard drive.\n  \n  # Executes Bismark alignment using 02.01-bismark-bowtie2-alignment-SLURM-array.sh script.\n  \n  # To execture this SLURM script as an array, start the script with the following command:\n  \n  # sbatch --array=0-$(($$(wc -l < fastq_pairs.txt) - 1)) 02.02-bismark-SLURM-job.sh\n  \n  # IMPORTANT: Requires fastq_pairs.txt to exist prior to submission!\n  apptainer exec \\\n  --home \"$PWD\" \\\n  --bind /mmfs1/home/ \\\n  --bind /gscratch \\\n  /gscratch/srlab/sr320/srlab-bioinformatics-container-586bf21.sif \\\n  /gscratch/scrubbed/samwhite/gitrepos/ceasmallr/code/02.01-bismark-bowtie2-alignment-SLURM-array.sh\n  ```\n\n- Job script:\n\n  - [02.01-bismark-bowtie2-alignment-SLURM-array.sh](https://github.com/sr320/ceasmallr/blob/main/code/02.01-bismark-bowtie2-alignment-SLURM-array.sh) (GitHub repo)\n\n  ```bash\n  #!/bin/bash\n  \n  # This script is designed to be called by a SLURM script which\n  # runs this script across an array of HPC nodes.\n  \n  \n  ###################################################################################\n  # These variables need to be set by user\n  \n  ## Assign Variables\n  \n  # INPUT FILES\n  repo_dir=\"/gscratch/scrubbed/samwhite/gitrepos/ceasmallr\"\n  trimmed_fastqs_dir=\"${repo_dir}/output/00.00-trimming-fastp\"\n  bisulfite_genome_dir=\"${repo_dir}/data/Cvirginica_v300\"\n  \n  \n  # OUTPUT FILES\n  output_dir_top=\"${repo_dir}/output/02.01-bismark-bowtie2-alignment-SLURM-array\"\n  \n  # PARAMETERS\n  bowtie2_min_score=\"L,0,-0.6\"\n  \n  \n  # CPU threads\n  # Bismark already spawns multiple instances and additional threads are multiplicative.\"\n  bismark_threads=15\n  \n  ###################################################################################\n  \n  # Print name of container\n  \n  echo \"Running in Apptainer container: ${APPTAINER_CONTAINER}\"\n  echo \"\"\n  \n  # Make output directory, if it doesn't exist\n  mkdir --parents \"02.01-bismark-bowtie2-alignment-SLURM-array\"${output_dir_top}\"\"\n  \n  ## CREATE LIST OF PAIRED READS ##\n  \n  cd \"${trimmed_fastqs_dir}\"\n  \n  if [[ -f \"${output_dir_top}\"/fastq_pairs.txt ]]; then\n    rm \"${output_dir_top}\"/fastq_pairs.txt\n  fi\n  \n  # Find all _R1_ files and match them with their corresponding _R2_ files\n  for R1_file in *_R1_*.fq.gz; do\n      R2_file=\"${R1_file/_R1_/_R2_}\"\n      if [[ -f \"$R2_file\" ]]; then\n          echo \"$R1_file $R2_file\" >> \"${output_dir_top}\"/fastq_pairs.txt\n      else\n          echo \"Warning: No matching R2 file for $R1_file\"\n      fi\n  done\n  \n  \n  ## SET ARRAY TASKS ##\n  cd \"${output_dir_top}\"\n  \n  # Get the FastQ file pair for this task\n  pair=$(sed -n \"${SLURM_ARRAY_TASK_ID}p\" fastq_pairs.txt)\n  \n  R1=$(echo $pair | awk '{print $1}')\n  \n  R2=$(echo $pair | awk '{print $2}')\n  \n  \n  # Check if R1 and R2 are not empty\n  if [ -z \"$R1\" ] || [ -z \"$R2\" ]; then\n    echo \"Error: R1 or R2 is empty. Exiting.\"\n    exit 1\n  fi\n  \n  # Get just the sample name (excludes the _R[12]_001*)\n  sample_name=\"${R1%%_*}\"\n  \n  # Check if sample_name is not empty\n  if [ -z \"$sample_name\" ]; then\n    echo \"Error: sample_name is empty. Exiting.\"\n    exit 1\n  fi\n  \n  \n  ## RUN BISMARK ALIGNMENTS ##\n  bismark \\\n  --genome ${bisulfite_genome_dir} \\\n  --score_min \"${bowtie2_min_score}\" \\\n  --parallel \"${bismark_threads}\" \\\n  --non_directional \\\n  --gzip \\\n  -p \"${bismark_threads}\" \\\n  -1 ${trimmed_fastqs_dir}/${R1} \\\n  -2 ${trimmed_fastqs_dir}/${R2} \\\n  --output_dir \"${output_dir_top}\" \\\n  2> \"${output_dir_top}\"/${sample_name}-${SLURM_ARRAY_TASK_ID}-bismark_summary.txt\n  ```\n\n\n# RESULTS\n\n## Outputs\n\nThe expected outputs will be:\n\n-   `*_R1_001.fastp-trim_bismark_bt2_PE_report.txt`: A text file summarizing the alignment input and results. Despite the `R1` naming, these reports are based on *paired reads*; the `R1` naming is a quirk of [Bismark](https://felixkrueger.github.io/Bismark/).\n\n-   `*_R1_001.fastp-trim_bismark_bt2_pe.bam`:A BAM alignment. Despite the `R1` naming, these BAMs are *paired reads*; the `R1` naming is a quirk of [Bismark](https://felixkrueger.github.io/Bismark/).\n\n-   `bismark_summary.txt`: An overall summary report of the alignment process. Essentially, this is all of the individual `*report.txt` files combined into a single file.\n\n-   `multiqc_report.html`: A summary report of the alignment results generated by [MultiQC](https://github.com/MultiQC/MultiQC), in HTML format.\n\nDue to the large file sizes of BAMS, these cannot be hosted in the [ceasmallr GitHub repo](https://github.com/sr320/ceasmallr). As such these files are available for download here:\n\n- [https://gannet.fish.washington.edu/gitrepos/ceasmallr/](https://gannet.fish.washington.edu/gitrepos/ceasmallr/)\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}